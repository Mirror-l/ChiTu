/*!
 * 
 *  maishu-chitu v2.8.4
 *  https://github.com/ansiboy/services-sdk
 *  
 *  Copyright (c) 2016-2018, shu mai <ansiboy@163.com>
 *  Licensed under the MIT License.
 * 
 */
define(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){var n;e.exports=function e(t,r,s){function a(o,l){if(!r[o]){if(!t[o]){var u="function"==typeof n&&n;if(!l&&u)return n(o,!0);if(i)return i(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var h=r[o]={exports:{}};t[o][0].call(h.exports,function(e){var r=t[o][1][e];return a(r||e)},h,h.exports,e,t,r,s)}return r[o].exports}for(var i="function"==typeof n&&n,o=0;o<s.length;o++)a(s[o]);return a}({1:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});class n{constructor(){this.funcs=new Array}add(e){this.funcs.push(e)}remove(e){this.funcs=this.funcs.filter(t=>t!=e)}fire(...e){this.funcs.forEach(t=>t(...e))}}r.Callback=n,r.Callbacks=function(){return new n}},{}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.errors={serviceUrlCanntNull(e){let t=`Service '${e}' base url can not null.`;return new Error(t)},unexpectedNullResult:()=>new Error("Null result is unexpected."),unexpectedNullValue(e){let t=`variable ${e} is unexpected null value.`;return new Error(t)},argumentNull(e){let t=`Arugment ${e} cannt null or empty.`;return new Error(t)},fieldNull(e,t){let r=`${t} ${e} cannt be null or empty`;return new Error(r)},instanceMessangerStart:()=>new Error("Instance messanger is start.")}},{}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./service");r.Service=n.Service;var s=e("./callback");r.Callback=s.Callback,r.Callbacks=s.Callbacks;var a=e("./value-store");r.ValueStore=a.ValueStore},{"./callback":1,"./service":4,"./value-store":5}],4:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(s,a){function i(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?s(e.value):new r(function(t){t(e.value)}).then(i,o)}l((n=n.apply(e,t||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0});const s=e("./callback"),a=e("./errors");class i{constructor(){this.error=s.Callbacks()}ajax(e,t){void 0===t&&(t={});let r,s=t.data,o=t.method,l=t.headers||{};if(null!=s){let e=(l["content-type"]||"").indexOf("json")>=0;if(e)r=JSON.stringify(s);else{r=new URLSearchParams;for(let e in s)r.append(e,s[e])}}return new Promise((t,s)=>{let u,c={headers:l,body:r,method:o};if(null==c)throw a.errors.unexpectedNullValue("options");"get"==o&&(u=setTimeout(()=>{let e=new Error;e.name="timeout",e.message="网络连接超时",s(e),this.error.fire(this,e),clearTimeout(u)},1e3*i.settings.ajaxTimeout)),function(e,t){return n(this,void 0,void 0,function*(){let r,n=yield fetch(e,t),s=n.text();r="string"==typeof s?new Promise((e,t)=>{e(s)}):s;let a,i=yield s,o=(n.headers.get("content-type")||"").indexOf("json")>=0;if(a=o?i?JSON.parse(i):null:i,n.status>=300){let e=new Error;throw e.method=t.method,e.name=`${n.status}`,e.message=o?a.Message||a.message:a,e.message=e.message||n.statusText,e}return a})}(e,c).then(e=>{t(e),u&&clearTimeout(u)}).catch(e=>{s(e),this.error.fire(this,e),u&&clearTimeout(u)})})}createService(e){let t=new(e=e||i);return t.error.add((e,r)=>{this.error.fire(t,r)}),t}}i.settings={ajaxTimeout:30},r.Service=i},{"./callback":1,"./errors":2}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ValueStore=class{constructor(e){this.items=new Array,this._value=void 0===e?null:e}add(e,t){return this.items.push({func:e,sender:t}),e}remove(e){this.items=this.items.filter(t=>t.func!=e)}fire(e){this.items.forEach(t=>t.func(e,t.sender))}get value(){return void 0===this._value?null:this._value}set value(e){this._value=e,this.fire(e)}}},{}]},{},[3])(3)},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(s,a){function i(e){try{l(n.next(e))}catch(e){a(e)}}function o(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){e.done?s(e.value):new r(function(t){t(e.value)}).then(i,o)}l((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),a=r(2),i=r(3);class o{constructor(e,t){if(this.pageCreated=s.Callbacks(),this.pageShowing=s.Callbacks(),this.pageShown=s.Callbacks(),this.pageType=a.Page,this.pageDisplayType=a.PageDisplayerImplement,this.cachePages={},this.page_stack=new Array,this.nodes={},this.error=s.Callbacks(),this.parser=t||this.defaultPageNodeParser(),!e)throw i.Errors.argumentNull("container");this.parser.actions=this.parser.actions||{},this.container=e}defaultPageNodeParser(){let e={};return{actions:{},parse:t=>{let r=e[t];if(null==r){let n=`modules_${t}`.split("_").join("/");r={action:this.createDefaultAction(n,this.loadjs),name:t},e[t]=r}return r}}}createDefaultAction(e,t){return r=>n(this,void 0,void 0,function*(){let n=yield t(e);if(!n)throw i.Errors.exportsCanntNull(e);let s,a=n.default;if(null==a)throw i.Errors.canntFindAction(r.name);if(o.isClass(a)){s=new a(r,this)}else{s=a(r,this)}return s})}loadjs(e){return new Promise((t,r)=>{requirejs([e],function(e){t(e)},function(e){r(e)})})}on_pageCreated(e){return this.pageCreated.fire(this,e)}get currentPage(){return this.page_stack.length>0?this.page_stack[this.page_stack.length-1]:null}getPage(e,t){console.assert(null!=e),t=t||{};let r=e.name,n=this.cachePages[r];if(null!=n)return n.data=t||{},{page:n,isNew:!1};let s=this.createPage(r,t);return this.cachePages[r]=s,this.on_pageCreated(s),{page:s,isNew:!0}}createPage(e,t){if(!e)throw i.Errors.argumentNull("pageName");t=t||{};let r=this.createPageElement(e),n=new this.pageDisplayType(this);console.assert(null!=this.pageType);let s=new this.pageType({app:this,name:e,data:t,displayer:n,element:r}),a=e=>{this.pageShowing.fire(this,e)},o=e=>{this.pageShown.fire(this,e)};return s.showing.add(a),s.shown.add(o),s.closed.add(()=>{s.showing.remove(a),s.shown.remove(o)}),s}createPageElement(e){let t=document.createElement(a.Page.tagName);return this.container.appendChild(t),t}showPage(e,t,r){if(t=t||{},r=null!=r,!e)throw i.Errors.argumentNull("pageName");let n=this.findSiteMapNode(e);if(null==n)throw i.Errors.pageNodeNotExists(e);if(null!=this.currentPage&&this.currentPage.name==e)return this.currentPage;let{page:s,isNew:a}=this.getPage(n,t);if(a||r){let t=this.findSiteMapNode(e);if(null==t)throw i.Errors.pageNodeNotExists(e);let r=t.action;if(null==r)throw i.Errors.actionCanntNull(e);r(s,this)}return s.show(),this.pushPage(s),console.assert(s==this.currentPage,"page is not current page"),s}closePage(e){if(null==e)throw i.Errors.argumentNull("page");e.close(),delete this.cachePages[e.name],this.page_stack=this.page_stack.filter(t=>t!=e)}pushPage(e){this.page_stack.push(e)}findSiteMapNode(e){if(this.nodes[e])return this.nodes[e];let t=null,r=this.parser.actions?this.parser.actions[e]:null;return null!=r&&(t={action:r,name:e}),null==t&&null!=this.parser.parse&&(t=this.parser.parse(e),console.assert(null!=t.action)),null!=t&&(this.nodes[e]=t),t}closeCurrentPage(e){var t=this.page_stack.pop();null!=t&&(this.closePage(t),this.currentPage&&(e&&(console.assert(null!=this.currentPage.data),this.currentPage.data=Object.assign(this.currentPage.data,e)),this.currentPage.show()))}get pageStack(){return this.page_stack}}o.isClass=function(){var e=Function.prototype.toString;return function(t){return"function"==typeof t&&(/^class(\s|\{\}$)/.test(e.call(t))||/^.*classCallCheck\(/.test(function(t){return e.call(t).replace(/^[^{]*{\s*/,"").replace(/\s*}[^}]*$/,"")}(t)))}}(),t.PageMaster=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);class s{constructor(e){this.data={},this.showing=n.Callbacks(),this.shown=n.Callbacks(),this.hiding=n.Callbacks(),this.hidden=n.Callbacks(),this.closing=n.Callbacks(),this.closed=n.Callbacks(),this._element=e.element,this._app=e.app,this._displayer=e.displayer,this.data=e.data,this._name=e.name}on_showing(){return this.showing.fire(this,this.data)}on_shown(){return this.shown.fire(this,this.data)}on_hiding(){return this.hiding.fire(this,this.data)}on_hidden(){return this.hidden.fire(this,this.data)}on_closing(){return this.closing.fire(this,this.data)}on_closed(){return this.closed.fire(this,this.data)}show(){this.on_showing();let e=this._app.currentPage;return this==e&&(e=null),this._displayer.show(this,e).then(e=>{this.on_shown()})}hide(e){return this.on_hiding(),this._displayer.hide(this,e).then(e=>{this.on_hidden()})}close(){return this.on_closing(),this._element.remove(),this.on_closed(),Promise.resolve()}createService(e){let t=new(e=e||n.Service);return t.error.add((e,t)=>{this._app.error.fire(this._app,t,this)}),t}get element(){return this._element}get name(){return this._name}get app(){return this._app}}s.tagName="div",t.Page=s;t.PageDisplayerImplement=class{show(e,t){return e.element.style.display="block",null!=t&&(t.element.style.display="none"),Promise.resolve()}hide(e,t){return e.element.style.display="none",null!=t&&(t.element.style.display="block"),Promise.resolve()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Errors=class{static pageNodeNotExists(e){return new Error(`Page node named ${e} is not exists.`)}static actionCanntNull(e){return new Error(`Action of '${e}' can not be null.`)}static argumentNull(e){return new Error(`The argument "${e}" cannt be null.`)}static modelFileExpecteFunction(e){return new Error(`The eval result of script file "${e}" is expected a function.`)}static paramTypeError(e,t){return new Error(`The param "${e}" is expected "${t}" type.`)}static paramError(e){return new Error(e)}static pathPairRequireView(e){return new Error(`The view value is required for path pair, but the item with index "${e}" is miss it.`)}static notImplemented(e){return new Error(`'The method "${e}" is not implemented.'`)}static routeExists(e){return new Error(`Route named "${e}" is exists.`)}static noneRouteMatched(e){return new Error(`None route matched with url "${e}".`)}static emptyStack(){return new Error("The stack is empty.")}static canntParseUrl(e){return new Error(`Can not parse the url "${e}" to route data.`)}static canntParseRouteString(e){return new Error(`Can not parse the route string "${e}" to route data.;`)}static routeDataRequireController(){return new Error('The route data does not contains a "controller" file.')}static routeDataRequireAction(){return new Error('The route data does not contains a "action" file.')}static viewCanntNull(){return new Error("The view or viewDeferred of the page cannt null.")}static createPageFail(e){return new Error(`Create page "${e}" fail.`)}static actionTypeError(e){return new Error(`The action in page '${e}' is expect as function.`)}static canntFindAction(e){return new Error(`Cannt find action in page '${e}', is the exports has default field?`)}static exportsCanntNull(e){return new Error(`Exports of page '${e}' is null.`)}static scrollerElementNotExists(){return new Error("Scroller element is not exists.")}static resourceExists(e,t){return new Error(`Rosource '${e}' is exists in the resources of page '${t}'.`)}static siteMapRootCanntNull(){return new Error("The site map root node can not be null.")}static duplicateSiteMapNode(e){return new Error(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(5);t.Application=n.Application;var s=r(1);t.PageMaster=s.PageMaster;var a=r(2);t.Page=a.Page;var i=r(0);t.Callback=i.Callback,t.Callbacks=i.Callbacks,t.ValueStore=i.ValueStore,t.Service=i.Service},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(1),a=r(3),i="",o="index";function l(e,t){if(!e)throw a.Errors.argumentNull("app");if(!t)throw a.Errors.argumentNull("url");let r,n,s=t.indexOf("#");if(!(r=s>=0?t.substr(s+1):t))throw a.Errors.canntParseRouteString(t);if(r.startsWith("!"))throw a.Errors.canntParseRouteString(r);let i=null,l=r.indexOf("?");l>=0?(i=r.substr(l+1),n=r.substring(0,l)):n=r,n||(n=o);let u={};return i&&(u=function(e){let t,r=/\+/g,n=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))},a={};for(;t=n.exec(e);)a[s(t[1])]=s(t[2]);return a}(i)),{pageName:n,values:u}}t.Application=class extends s.PageMaster{constructor(e){super((e||{}).container||document.body,(e||{}).parser),this._runned=!1,this.closeCurrentOnBack=null,this.tempPageData=void 0}parseUrl(e){if(!e)throw a.Errors.argumentNull("url");return l(this,e)}createUrl(e,t){return function(e,t){let r=e.split(".").join("/");if(!t)return`#${r}`;let n="";for(let e in t){let r=t[e];"string"==typeof t[e]&&null!=r&&(n=""==n?`?${e}=${t[e]}`:n+`&${e}=${t[e]}`)}return`#${r}${n}`}(e,t)}run(){if(this._runned)return;let e=()=>{let e=location.href,t=e.indexOf("#");e.substr(t+1).startsWith("!")||(t<0&&(e="#"+o),this.showPageByUrl(e,!0))};e(),window.addEventListener("popstate",()=>{e()}),this._runned=!0}showPageByUrl(e,t){if(!e)throw a.Errors.argumentNull("url");var r=this.parseUrl(e);if(null==r)throw a.Errors.noneRouteMatched(e);let n=this.fetchTemplatePageData(),s=null;if(1==this.closeCurrentOnBack)this.closeCurrentOnBack=null,null==n?this.closeCurrentPage():this.closeCurrentPage(n),s=this.currentPage;else if(0==this.closeCurrentOnBack){this.closeCurrentOnBack=null;var i=this.pageStack.pop();if(null==i)throw new Error("page is null");i.hide(this.currentPage),s=this.currentPage}if(null==s||s.name!=r.pageName){let e=r.values||{};n&&(e=Object.assign(e,n)),s=this.showPage(r.pageName,e)}return s}fetchTemplatePageData(){if(null==this.tempPageData)return null;let e=this.tempPageData;return this.tempPageData=void 0,e}setLocationHash(e){history.pushState(i,"",e)}redirect(e,t){if(!e)throw a.Errors.argumentNull("pageNameOrUrl");let r=this.showPageByNameOrUrl(e,t),n=this.createUrl(r.name,r.data);return this.setLocationHash(n),r}forward(e,t,r){if(!e)throw a.Errors.argumentNull("pageNameOrUrl");null==r&&(r=!0);let n=this.showPageByNameOrUrl(e,t,!0);if(r){let e=this.createUrl(n.name,n.data);this.setLocationHash(e)}else history.pushState(e,"","");return n}showPageByNameOrUrl(e,t,r){let n;if(e.indexOf("?")<0)n=e;else{let r=this.parseUrl(e);n=r.pageName,t=Object.assign(r.values,t||{})}return this.showPage(n,t,r)}reload(e,t){return this.showPage(e,t,!0)}back(e,t){"object"==typeof e&&(t=e,e=null),this.closeCurrentOnBack=null==e||e,this.tempPageData=t,history.back()}createService(e){let t=new(e=e||n.Service);return t.error.add((e,t)=>{this.error.fire(this,t,null)}),t}}}])});