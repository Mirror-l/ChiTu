/*! Author: Shu Mai, Contact: ansiboy@163.com */
var chitu;!function(a){var b=a.Errors,c=function(){function a(){}return a.isType=function(a,b){for(var c in a.prototype)if(void 0===b[c])return!1;return!0},a.isDeferred=function(a){return null==a?!1:null!=a.pipe&&null!=a.always&&null!=a.done?!0:!1},a.format=function(a,b){return arguments.length>2&&b.constructor!==Array&&(b=$.makeArray(arguments).slice(1)),b.constructor!==Array&&(b=[b]),$.each(b,function(b,c){a=a.replace(new RegExp("\\{"+b+"\\}","g"),function(){return c})}),a},a.fileName=function(a,c){if(!a)throw b.argumentNull("url");c=c||!0,a=a.replace("http://","/");var d=a.replace(/^.*[\\\/]/,"");if(c===!0){var e=d.split(".");d=e[0]}return d},a.log=function(a,b){if(void 0===b&&(b=[]),window.console){if(null==b)return void console.log(a);var c=this.format.apply(this,arguments);console.log(c)}},a}();a.Utility=c}(chitu||(chitu={}));var chitu;!function(a){var b=a.Utility,c=function(){function a(){}return a.argumentNull=function(a){var c=b.format('The argument "{0}" cannt be null.',[a]);return new Error(c)},a.modelFileExpecteFunction=function(a){var c=b.format('The eval result of script file "{0}" is expected a function.',a);return new Error(c)},a.paramTypeError=function(a,c){var d=b.format('The param "{0}" is expected "{1}" type.',[a,c]);return new Error(d)},a.viewNodeNotExists=function(a){var c=b.format('The view node "{0}" is not exists.',a);return new Error(c)},a.pathPairRequireView=function(a){var c=b.format('The view value is required for path pair, but the item with index "{0}" is miss it.',a);return new Error(c)},a.notImplemented=function(a){var c=b.format('The method "{0}" is not implemented.',a);return new Error(c)},a.routeExists=function(a){var c=b.format('Route named "{0}" is exists.',a);return new Error(c)},a.routeResultRequireController=function(a){var c=b.format('The parse result of route "{0}" does not contains controler.',a);return new Error(c)},a.routeResultRequireAction=function(a){var c=b.format('The parse result of route "{0}" does not contains action.',a);return new Error(c)},a.ambiguityRouteMatched=function(a,c,d){var e=b.format("Ambiguity route matched, {0} is match in {1} and {2}.",[a,c,d]);return new Error(e)},a.noneRouteMatched=function(a){var c=b.format('None route matched with url "{0}".',a),d=new Error(c);return d},a.emptyStack=function(){return new Error("The stack is empty.")},a.canntParseUrl=function(a){var c=b.format('Can not parse the url "{0}" to route data.',[a]);return new Error(c)},a.routeDataRequireController=function(){var a='The route data does not contains a "controller" file.';return new Error(a)},a.routeDataRequireAction=function(){var a='The route data does not contains a "action" file.';return new Error(a)},a.parameterRequireField=function(a,c){var d=b.format("Parameter {1} does not contains field {0}.",[a,c]);return new Error(d)},a}();a.Errors=c}(chitu||(chitu={}));var chitu;!function(a){function b(a){var b=f[a]={};return jQuery.each(a.match(e)||[],function(a,c){b[c]=!0}),b}function c(c){void 0===c&&(c=null),c="string"==typeof c?f[c]||b(c):jQuery.extend({},c);var d,e,g,h,i,j,k=[],l=!c.once&&[],m=function(a){for(d=c.memory&&a,e=!0,j=h||0,h=0,i=k.length,g=!0;k&&i>j;j++){var b=k[j].apply(a[0],a[1]);if(null!=b&&a[0].results.push(b),b===!1&&c.stopOnFalse){d=!1;break}}g=!1,k&&(l?l.length&&m(l.shift()):d?k=[]:n.disable())},n={results:[],add:function(){if(k){var a=k.length;!function b(a){jQuery.each(a,function(a,d){var e=jQuery.type(d);"function"===e?c.unique&&n.has(d)||k.push(d):d&&d.length&&"string"!==e&&b(d)})}(arguments),g?i=k.length:d&&(h=a,m(d))}return this},remove:function(){return k&&jQuery.each(arguments,function(a,b){for(var c;(c=jQuery.inArray(b,k,c))>-1;)k.splice(c,1),g&&(i>=c&&i--,j>=c&&j--)}),this},has:function(a){return a?jQuery.inArray(a,k)>-1:!(!k||!k.length)},empty:function(){return k=[],i=0,this},disable:function(){return k=l=d=void 0,this},disabled:function(){return!k},lock:function(){return l=void 0,d||n.disable(),this},locked:function(){return!l},fireWith:function(a,b){return a.results=[],!k||e&&!l||(b=b||[],b=[a,b.slice?b.slice():b],g?l.push(b):m(b)),a.results},fire:function(){return n.fireWith(this,arguments)},fired:function(){return!!e},count:function(){return k.length}};return new a.Callback(n)}function d(b,c){for(var d=b.fire(c),e=[],f=0;f<d.length;f++)a.Utility.isDeferred(d[f])&&e.push(d[f]);return 0==e.length?$.Deferred().resolve():$.when.apply($,e)}var e=/\S+/g,f={},g=function(){function a(a){this.source=a}return a.prototype.add=function(a){this.source.add(a)},a.prototype.remove=function(a){this.source.remove(a)},a.prototype.has=function(a){return this.source.has(a)},a.prototype.fireWith=function(a,b){return this.source.fireWith(a,b)},a.prototype.fire=function(a){return this.source.fire(a)},a}();a.Callback=g,a.callbacks=c,a.fireCallback=d;var h=window.crossroads;$.extend(h,{_create:h.create,create:function(){var b=this._create();return b.getRouteData=function(b,c){if(b=b||"",c=c||[],this.ignoreState||b!==this._prevMatchedRequest&&b!==this._prevBypassedRequest){var d=this._getMatchedRoutes(b),e=d.length;if(0==e)return null;if(e>1)throw a.Errors.ambiguityRouteMatched(b,"route1","route2");return d[0]}},b}})}(chitu||(chitu={}));var chitu;!function(a){var b=a,c=a.Errors,d=function(){function a(a,c){this.pageCreating=b.callbacks(),this.pageCreated=b.callbacks(),this.pageShowing=b.callbacks(),this.pageShown=b.callbacks(),this.init(a,c)}return a.prototype.init=function(a,b){this._app=a,this._node=b,this._pageStack=[]},a.prototype.on_pageCreating=function(a){return b.fireCallback(this.pageCreating,[this,a])},a.prototype.on_pageCreated=function(a){return b.fireCallback(this.pageCreated,[this,a])},a.prototype.on_pageShowing=function(a,c){return b.fireCallback(this.pageShowing,[this,a,c])},a.prototype.on_pageShown=function(a,c){return b.fireCallback(this.pageShown,[this,a,c])},a.prototype.application=function(){return this._app},a.prototype.node=function(){return this._node},a.prototype.currentPage=function(){return this._currentPage},a.prototype._createPage=function(a,d){if(!a)throw c.argumentNull("url");if("string"!=typeof a)throw c.paramTypeError("url","String");d||(d=document.createElement("div"),document.body.appendChild(d));var e=this.application().routes().getRouteData(a);if(null==e)throw c.noneRouteMatched(a);var f=(e.controller,e.action,this.application().controller(e)),g=this.application().viewFactory.view(e),h=new b.ControllerContext(f,g,e);this.on_pageCreating(h);var i=new b.Page(h,d);return this.on_pageCreated(i),i},a.prototype.showPage=function(a,b){if(b=b||{},!a)throw c.argumentNull("url");var d=this.application().routes().getRouteData(a);if(null==d)throw c.noneRouteMatched(a);var e=this.node(),f=d.controller,g=d.action,h=f+"."+g,i=$(e).data("pages");i||(i={},$(e).data("pages",i));var j=this,k=i[h];if(null==k){var l=$("<div>").appendTo(e)[0];k=this._createPage(a,l),i[h]=k}this._currentPage=k;for(var m in i)i[m]!=this._currentPage&&i[m].visible(!1);$.extend(b,d);var j=this,n=$.Deferred();return this.on_pageShowing(k,b).pipe(function(){return k.open(b)}).done($.proxy(function(){j._pageStack.push({page:this.page,url:this.url}),this.page!=j.currentPage()&&this.page.visible(!1),this.result.resolve(this.page),j.on_pageShown(this.page,b)},{page:k,result:n,url:a})).fail($.proxy(function(a){this.result.reject(this.page,a)},{page:k,result:n,url:a})),n},a.prototype.back=function(a){var b=this._pageStack,c=this.currentPage();if(0==b.length||null==c)return $.Deferred().reject();b.pop();var d=b[b.length-1];if(null==d)return $.Deferred().reject();var e="#"+d.url.toLowerCase();return 0!=e.localeCompare(window.location.hash.toLowerCase())&&(window.location.hash=d.url,window.location.skip=!0),c.visible(!1),a?d.page.open(a):d.page.visible(!0),this._currentPage=d.page,$.Deferred().resolve()},a}();a.PageContainer=d}(chitu||(chitu={}));var chitu;!function(a){function b(b,c,d){return void 0===d&&(d={}),a.fireCallback(b,[c,d])}var c=a,d=a.Utility,e=a.Errors,f=function(){function a(a,b){if(this._node=HTMLElement,this._visible=!0,this._loadViewModelResult=null,this._showResult=null,this._hideResult=null,this.created=c.callbacks(),this.creating=c.callbacks(),this.preLoad=c.callbacks(),this.load=c.callbacks(),this.closing=c.callbacks(),this.closed=c.callbacks(),this.scroll=c.callbacks(),this.showing=c.callbacks(),this.shown=c.callbacks(),this.hiding=c.callbacks(),this.hidden=c.callbacks(),this._type="Page",!a)throw e.argumentNull("context");if("ControllerContext"!=a._type)throw e.paramTypeError("context","ControllerContext");if(!b)throw e.argumentNull("node");this._context=a;var d=a.routeData().controller,f=a.routeData().action,g=d+"."+f,h=a.view(),i=a.controller().action(f);this.init(g,h,i,b)}return a.prototype.context=function(){return this._context},a.prototype.name=function(){return this._name},a.prototype.node=function(){return this._node},a.prototype.parent=function(){return this._parent},a.prototype.visible=function(a){var b=$(this.node()).is(":visible");return void 0===a?b:void(a!=b&&(a?(this.on_showing({}),$(this.node()).show(),this.on_shown({})):(this.on_hiding({}),$(this.node()).hide(),this.on_hidden({})),this._visible=a))},a.prototype.init=function(a,b,c,d){if(!a)throw e.argumentNull("name");if(!b)throw e.argumentNull("viewDeferred");if(!c)throw e.argumentNull("actionDeferred");if(!d)throw e.argumentNull("node");this._name=a,this._viewDeferred=b,this._actionDeferred=c,this._parent,this._node=d,this._visible=!0,$(this._node).hide()},a.prototype.on_creating=function(a){return b(this.creating,this,a)},a.prototype.on_created=function(){return b(this.created,this)},a.prototype.on_preLoad=function(a){return b(this.preLoad,this,a)},a.prototype.on_load=function(a){return b(this.load,this,a)},a.prototype.on_closing=function(a){return b(this.closing,this,a)},a.prototype.on_closed=function(a){return b(this.closed,this,a)},a.prototype.on_scroll=function(a){return b(this.scroll,this,a)},a.prototype.on_showing=function(a){return b(this.showing,this,a)},a.prototype.on_shown=function(a){return b(this.shown,this,a)},a.prototype.on_hiding=function(a){return b(this.hiding,this,a)},a.prototype.on_hidden=function(a){return b(this.hidden,this,a)},a.prototype._appendNode=function(a){if(null==a)throw e.argumentNull("childNode");$(this._node).append(a)},a.prototype._loadViewModel=function(){if(this._loadViewModelResult)return this._loadViewModelResult;var a=this;return this._loadViewModelResult=this._viewDeferred.pipe(function(b){return d.log("Load view success, page:{0}.",[a._name]),$(a.node()).html(b),a._actionDeferred}).pipe(function(b){var c=b.execute(a);return a.on_created(),d.isDeferred(c)?c:$.Deferred().resolve()}).fail(function(){a._loadViewModelResult=null,d.log("Load view or action fail, page：{0}.",[a._name])}),this._loadViewModelResult},a.prototype.open=function(a){var b=this;return this._showResult=this.on_preLoad(a).pipe(function(){return b._loadViewModel()}).pipe(function(){return b.on_showing(a),b.on_load(a)}),this._showResult.done($.proxy(function(){b._hideResult=null,$(b.node()).show(),b.on_shown(this.args)},{args:a})),this._showResult},a.prototype.close=function(a){var b=this;return this._hideResult||(this._hideResult=b.on_closing(a).pipe(function(){return b.visible(!1),b.on_closed(a)})),this._hideResult.always(function(){b._hideResult=null})},a}();a.Page=f}(chitu||(chitu={}));var chitu;!function(a){function b(a,b){var c="http://".toLowerCase();if(a.substr(0,c.length).toLowerCase()==c){var d=document.createElement("a");d.setAttribute("href",a),a=d.pathname;var e=f.addRoute(a);return c+e.interpolate(b)}var e=f.addRoute(a);return e.interpolate(b)}var c=a,d=c.Errors,e=c.Utility,f=window.crossroads,g=function(){function f(b,c){if(this._actions={},!b)throw d.argumentNull("routeData");if("object"!=typeof b)throw d.paramTypeError("routeData","object");if(!c)throw d.argumentNull("actionLocationFormater");this._name=b.controller,this._routeData=b,this._actionLocationFormater=c,this._actions={},this.actionCreated=a.callbacks()}return f.prototype.actionLocationFormater=function(){return this._actionLocationFormater},f.prototype.name=function(){return this._name},f.prototype.getLocation=function(a){if(!a)throw d.argumentNull("actionName");if("string"!=typeof a)throw d.paramTypeError("actionName","String");var c=$.extend(this._routeData,{action:a});return b(this.actionLocationFormater(),c)},f.prototype.action=function(a){if(!a)throw d.argumentNull("name");if("string"!=typeof a)throw d.paramTypeError("name","String");var b=this;return this._actions[a]||(this._actions[a]=this._createAction(a).fail($.proxy(function(){b._actions[this.actionName]=null},{actionName:a}))),this._actions[a]},f.prototype._createAction=function(a){if(!a)throw d.argumentNull("actionName");var b=this,f=this.getLocation(a),g=$.Deferred();return require([f],$.proxy(function(a){a||(console.warn(e.format("加载活动“{1}.{0}”失败，为该活动提供默认的值。",[this.actionName,b.name()])),a={func:function(){}});var d=a.func;if(!$.isFunction(d))throw c.Errors.modelFileExpecteFunction(this.actionName);var f=new h(b,this.actionName,d);b.actionCreated.fire(b,f),this.result.resolve(f)},{actionName:a,result:g}),$.proxy(function(a){console.warn(e.format("加载活动“{1}.{0}”失败，为该活动提供默认的值。",[this.actionName,b.name()]));var c=new h(b,this.actionName,function(){});b.actionCreated.fire(b,c),this.result.resolve(c)},{actionName:a,result:g})),g},f}();a.Controller=g;var h=function(){function a(a,b,c){if(!a)throw d.argumentNull("controller");if(!b)throw d.argumentNull("name");if(!c)throw d.argumentNull("handle");if(!$.isFunction(c))throw d.paramTypeError("handle","Function");this._name=b,this._handle=c}return a.prototype.name=function(){return this._name},a.prototype.execute=function(a){if(!a)throw d.argumentNull("page");if("Page"!=a._type)throw d.paramTypeError("page","Page");var b=this._handle.apply({},[a]);return e.isDeferred(b)?b:$.Deferred().resolve()},a}()}(chitu||(chitu={}));var chitu;!function(a){var b=function(){function a(a,b,c){this._controller=a,this._view=b,this._controller=c}return a.prototype.controller=function(){return this._controller},a.prototype.view=function(){return this._view},a.prototype.routeData=function(){return this._routeData},a}();a.ControllerContext=b}(chitu||(chitu={}));var chitu;!function(a){var b=a.Errors,c=a,d=function(){function a(a){if(this._controllers={},!a)throw b.argumentNull("actionLocationFormater");this._controllers={},this._actionLocationFormater=a}return a.prototype.controllers=function(){return this._controllers},a.prototype.createController=function(a){if(!a.controller)throw b.routeDataRequireController();return new c.Controller(a,a.actionPath||this.actionLocationFormater())},a.prototype.actionLocationFormater=function(){return this._actionLocationFormater},a.prototype.getController=function(a){if("object"!=typeof a)throw b.paramTypeError("routeData","object");if(!a.controller)throw b.routeDataRequireController();return this._controllers[a.controller]||(this._controllers[a.controller]=this.createController(a)),this._controllers[a.controller]},a}();a.ControllerFactory=d}(chitu||(chitu={})),function(a){var b=a.utility,c=a.Error,d="{controller}/{action}",e="{controller}/{action}";a.Application=function(b){if(!b)throw c.argumentNull("func");if(!$.isFunction(b))throw c.paramTypeError("func","Function");var f={container:document.body,routes:new a.RouteCollection,actionPath:d,viewPath:e};$.proxy(b,this)(f),this.controllerFactory=new a.ControllerFactory(f.actionPath),this.viewFactory=new a.ViewFactory(f.viewPath),this._pages={},this._stack=[],this._routes=f.routes,this._container=f.container,this.pageCreating=a.Callbacks(),this.pageCreated=a.Callbacks(),this.pageShowing=a.Callbacks(),this.pageShown=a.Callbacks()},a.Application.prototype={on_pageCreating:function(a){this.pageCreating.fire(this,a)},on_pageCreated:function(a){this.pageCreated.fire(this,a)},on_pageShowing:function(a,b){this.pageShowing.fire(this,a,b)},on_pageShown:function(a,b){this.pageShown.fire(this,a,b)},routes:function(){return this._routes},controller:function(a){if("object"!=typeof a)throw c.paramTypeError("routeData","object");if(!a)throw c.argumentNull("routeData");return this.controllerFactory.getController(a)},action:function(a){if("object"!=typeof a)throw c.paramTypeError("routeData","object");if(!a)throw c.argumentNull("routeData");var b=a.controller;if(!b)throw c.argumentNull("name");if("string"!=typeof b)throw c.routeDataRequireController();var d=a.action;if(!d)throw c.argumentNull("name");if("string"!=typeof d)throw c.routeDataRequireAction();var e=this.controller(a);return e.action(d)},run:function(){if(!this._runned){var a=this,c=function(c){var d=window.location.hash;if(!d)return void b.log("The url is not contains hash.");var e=window.location.arguments||{},f=window.location.container||a._container;window.location.arguments=null,window.location.container=null,(null==window.location.skip||0==window.location.skip)&&a.showPageAt(f,d.substr(1),e),window.location.skip=!1};$.proxy(c,this)(),$(window).bind("hashchange",$.proxy(c,this)),this._runned=!0}},showPageAt:function(b,d,e){if(e=e||{},!b)throw c.argumentNull("element");if(!d)throw c.argumentNull("url");var f=this,g=$(b).data("PageContainer");null==g&&(g=new a.PageContainer(this,b),g.pageCreating.add(function(a,b){f.on_pageCreating(b)}),g.pageCreated.add(function(a,b){f.on_pageCreated(b)}),g.pageShowing.add(function(a,b,c){f.on_pageShowing(b,c)}),g.pageShown.add(function(a,b,c){f.on_pageShown(b,c)}),$(b).data("PageContainer",g));var f=this;return g.showPage(d,e)},showPage:function(a,b){return this.showPageAt(this._container,a,b)},redirect:function(a,b){window.location.arguments=b,window.location.hash=a},back:function(a){var b=$(this._container).data("PageContainer");return null==b?$.Deferred().reject():b.back(a)}}}(chitu);