/*! Author: Shu Mai, Contact: ansiboy@163.com */
!function(a){"function"==typeof define&&define.amd?define(["jquery","crossroads","text"],a):"undefined"!=typeof module&&module.exports?module.exports=a(require(["jquery","crossroads","text"])):window.chitu=a($,crossroads)}(function(a,b){window.crossroads=b;var c;!function(b){var c=b.Errors,d=function(){function b(){}return b.isType=function(a,b){for(var c in a.prototype)if(void 0===b[c])return!1;return!0},b.isDeferred=function(a){return null==a?!1:null!=a.pipe&&null!=a.always&&null!=a.done?!0:!1},b.format=function(b,c){return void 0===c&&(c=[]),arguments.length>2&&c.constructor!==Array&&(c=a.makeArray(arguments).slice(1)),a.each(c,function(a,c){b=b.replace(new RegExp("\\{"+a+"\\}","g"),function(){return c})}),b},b.fileName=function(a,b){if(!a)throw c.argumentNull("url");b=b||!0,a=a.replace("http://","/");var d=a.replace(/^.*[\\\/]/,"");if(b===!0){var e=d.split(".");d=e[0]}return d},b.log=function(a,b){if(void 0===b&&(b=[]),window.console){if(null==b)return void console.log(a);var c=this.format.apply(this,arguments);console.log(c)}},b}();b.Utility=d}(c||(c={})),function(a){var b=a.Utility,c=function(){function a(){}return a.argumentNull=function(a){var c=b.format('The argument "{0}" cannt be null.',[a]);return new Error(c)},a.modelFileExpecteFunction=function(a){var c=b.format('The eval result of script file "{0}" is expected a function.',a);return new Error(c)},a.paramTypeError=function(a,c){var d=b.format('The param "{0}" is expected "{1}" type.',[a,c]);return new Error(d)},a.viewNodeNotExists=function(a){var c=b.format('The view node "{0}" is not exists.',a);return new Error(c)},a.pathPairRequireView=function(a){var c=b.format('The view value is required for path pair, but the item with index "{0}" is miss it.',a);return new Error(c)},a.notImplemented=function(a){var c=b.format('The method "{0}" is not implemented.',a);return new Error(c)},a.routeExists=function(a){var c=b.format('Route named "{0}" is exists.',a);return new Error(c)},a.routeResultRequireController=function(a){var c=b.format('The parse result of route "{0}" does not contains controler.',a);return new Error(c)},a.routeResultRequireAction=function(a){var c=b.format('The parse result of route "{0}" does not contains action.',a);return new Error(c)},a.ambiguityRouteMatched=function(a,c,d){var e=b.format("Ambiguity route matched, {0} is match in {1} and {2}.",[a,c,d]);return new Error(e)},a.noneRouteMatched=function(a){var c=b.format('None route matched with url "{0}".',a),d=new Error(c);return d},a.emptyStack=function(){return new Error("The stack is empty.")},a.canntParseUrl=function(a){var c=b.format('Can not parse the url "{0}" to route data.',[a]);return new Error(c)},a.routeDataRequireController=function(){var a='The route data does not contains a "controller" file.';return new Error(a)},a.routeDataRequireAction=function(){var a='The route data does not contains a "action" file.';return new Error(a)},a.parameterRequireField=function(a,c){var d=b.format("Parameter {1} does not contains field {0}.",[a,c]);return new Error(d)},a}();a.Errors=c}(c||(c={})),function(b){function c(a){var b=g[a]={};return jQuery.each(a.match(f)||[],function(a,c){b[c]=!0}),b}function d(a){void 0===a&&(a=null),a="string"==typeof a?g[a]||c(a):jQuery.extend({},a);var d,e,f,h,i,j,k=[],l=!a.once&&[],m=function(b){for(d=a.memory&&b,e=!0,j=h||0,h=0,i=k.length,f=!0;k&&i>j;j++){var c=k[j].apply(b[0],b[1]);if(null!=c&&b[0].results.push(c),c===!1&&a.stopOnFalse){d=!1;break}}f=!1,k&&(l?l.length&&m(l.shift()):d?k=[]:n.disable())},n={results:[],add:function(){if(k){var b=k.length;!function c(b){jQuery.each(b,function(b,d){var e=jQuery.type(d);"function"===e?a.unique&&n.has(d)||k.push(d):d&&d.length&&"string"!==e&&c(d)})}(arguments),f?i=k.length:d&&(h=b,m(d))}return this},remove:function(){return k&&jQuery.each(arguments,function(a,b){for(var c;(c=jQuery.inArray(b,k,c))>-1;)k.splice(c,1),f&&(i>=c&&i--,j>=c&&j--)}),this},has:function(a){return a?jQuery.inArray(a,k)>-1:!(!k||!k.length)},empty:function(){return k=[],i=0,this},disable:function(){return k=l=d=void 0,this},disabled:function(){return!k},lock:function(){return l=void 0,d||n.disable(),this},locked:function(){return!l},fireWith:function(a,b){return a.results=[],!k||e&&!l||(b=b||[],b=[a,b.slice?b.slice():b],f?l.push(b):m(b)),a.results},fire:function(){return n.fireWith(this,arguments)},fired:function(){return!!e},count:function(){return k.length}};return new b.Callback(n)}function e(c,d){for(var e=c.fire.apply(c,d),f=[],g=0;g<e.length;g++)b.Utility.isDeferred(e[g])&&f.push(e[g]);return 0==f.length?a.Deferred().resolve():a.when.apply(a,f)}var f=/\S+/g,g={},h=function(){function a(a){this.source=a}return a.prototype.add=function(a){this.source.add(a)},a.prototype.remove=function(a){this.source.remove(a)},a.prototype.has=function(a){return this.source.has(a)},a.prototype.fireWith=function(a,b){return this.source.fireWith(a,b)},a.prototype.fire=function(a,b,c,d){return this.source.fire(a,b,c)},a}();b.Callback=h,b.Callbacks=d,b.fireCallback=e;var i=window.crossroads;a.extend(i,{_create:i.create,create:function(){var a=this._create();return a.getRouteData=function(a,c){if(a=a||"",c=c||[],this.ignoreState||a!==this._prevMatchedRequest&&a!==this._prevBypassedRequest){var d=this._getMatchedRoutes(a),e=d.length;if(0==e)return null;if(e>1)throw b.Errors.ambiguityRouteMatched(a,"route1","route2");return d[0]}},a}})}(c||(c={})),function(b){var c=b,d=b.Errors,e=function(){function b(a,b){this.pageCreating=c.Callbacks(),this.pageCreated=c.Callbacks(),this.pageShowing=c.Callbacks(),this.pageShown=c.Callbacks(),this.init(a,b)}return b.prototype.init=function(a,b){this._app=a,this._node=b,this._pageStack=[]},b.prototype.on_pageCreating=function(a){return c.fireCallback(this.pageCreating,[this,a])},b.prototype.on_pageCreated=function(a){return c.fireCallback(this.pageCreated,[this,a])},b.prototype.on_pageShowing=function(a,b){return c.fireCallback(this.pageShowing,[this,a,b])},b.prototype.on_pageShown=function(a,b){return c.fireCallback(this.pageShown,[this,a,b])},b.prototype.application=function(){return this._app},b.prototype.node=function(){return this._node},b.prototype.currentPage=function(){return this._currentPage},b.prototype._createPage=function(a,b){if(!a)throw d.argumentNull("url");if("string"!=typeof a)throw d.paramTypeError("url","String");b||(b=document.createElement("div"),document.body.appendChild(b));var e=this.application().routes().getRouteData(a);if(null==e)throw d.noneRouteMatched(a);var f=(e.controller,e.action,this.application().controller(e)),g=this.application().viewFactory.view(e),h=new c.ControllerContext(f,g,e);this.on_pageCreating(h);var i=new c.Page(h,b);return this.on_pageCreated(i),i},b.prototype.showPage=function(b,c){if(c=c||{},!b)throw d.argumentNull("url");var e=this.application().routes().getRouteData(b);if(null==e)throw d.noneRouteMatched(b);var f=this.node(),g=e.controller,h=e.action,i=g+"."+h,j=a(f).data("pages");j||(j={},a(f).data("pages",j));var k=this,l=j[i];if(null==l){var m=a("<div>").appendTo(f)[0];l=this._createPage(b,m),j[i]=l}this._currentPage=l;for(var n in j)j[n]!=this._currentPage&&j[n].visible(!1);a.extend(c,e);var k=this,o=a.Deferred();return this.on_pageShowing(l,c).pipe(function(){return l.open(c)}).done(a.proxy(function(){k._pageStack.push({page:this.page,url:this.url}),this.page!=k.currentPage()&&this.page.visible(!1),this.result.resolve(this.page),k.on_pageShown(this.page,c)},{page:l,result:o,url:b})).fail(a.proxy(function(a){this.result.reject(this.page,a)},{page:l,result:o,url:b})),o},b.prototype.back=function(b){var c=this._pageStack,d=this.currentPage();if(0==c.length||null==d)return a.Deferred().reject();c.pop();var e=c[c.length-1];if(null==e)return a.Deferred().reject();var f="#"+e.url.toLowerCase();return 0!=f.localeCompare(window.location.hash.toLowerCase())&&(window.location.hash=e.url,window.location.skip=!0),d.visible(!1),b?e.page.open(b):e.page.visible(!0),this._currentPage=e.page,a.Deferred().resolve()},b}();b.PageContainer=e}(c||(c={})),function(b){function c(a,c,d){return void 0===d&&(d={}),b.fireCallback(a,[c,d])}var d=b,e=b.Utility,f=b.Errors,g=function(){function b(a,b){if(this._node=HTMLElement,this._visible=!0,this._loadViewModelResult=null,this._showResult=null,this._hideResult=null,this.created=d.Callbacks(),this.creating=d.Callbacks(),this.preLoad=d.Callbacks(),this.load=d.Callbacks(),this.closing=d.Callbacks(),this.closed=d.Callbacks(),this.scroll=d.Callbacks(),this.showing=d.Callbacks(),this.shown=d.Callbacks(),this.hiding=d.Callbacks(),this.hidden=d.Callbacks(),this._type="Page",!a)throw f.argumentNull("context");if(!b)throw f.argumentNull("node");this._context=a;var c=a.routeData().controller,e=a.routeData().action,g=c+"."+e,h=a.view(),i=a.controller().action(e);this.init(g,h,i,b)}return b.prototype.context=function(){return this._context},b.prototype.name=function(){return this._name},b.prototype.node=function(){return this._node},b.prototype.parent=function(){return this._parent},b.prototype.visible=function(b){var c=a(this.node()).is(":visible");return void 0===b?c:void(b!=c&&(b?(this.on_showing({}),a(this.node()).show(),this.on_shown({})):(this.on_hiding({}),a(this.node()).hide(),this.on_hidden({})),this._visible=b))},b.prototype.init=function(b,c,d,e){if(!b)throw f.argumentNull("name");if(!c)throw f.argumentNull("viewDeferred");if(!d)throw f.argumentNull("actionDeferred");if(!e)throw f.argumentNull("node");this._name=b,this._viewDeferred=c,this._actionDeferred=d,this._parent,this._node=e,this._visible=!0,a(this._node).hide()},b.prototype.on_creating=function(a){return c(this.creating,this,a)},b.prototype.on_created=function(){return c(this.created,this)},b.prototype.on_preLoad=function(a){return c(this.preLoad,this,a)},b.prototype.on_load=function(a){return c(this.load,this,a)},b.prototype.on_closing=function(a){return c(this.closing,this,a)},b.prototype.on_closed=function(a){return c(this.closed,this,a)},b.prototype.on_scroll=function(a){return c(this.scroll,this,a)},b.prototype.on_showing=function(a){return c(this.showing,this,a)},b.prototype.on_shown=function(a){return c(this.shown,this,a)},b.prototype.on_hiding=function(a){return c(this.hiding,this,a)},b.prototype.on_hidden=function(a){return c(this.hidden,this,a)},b.prototype._appendNode=function(b){if(null==b)throw f.argumentNull("childNode");a(this._node).append(b)},b.prototype._loadViewModel=function(){if(this._loadViewModelResult)return this._loadViewModelResult;var b=this;return this._loadViewModelResult=this._viewDeferred.pipe(function(c){return e.log("Load view success, page:{0}.",[b._name]),a(b.node()).html(c),b._actionDeferred}).pipe(function(c){var d=c.execute(b);return b.on_created(),e.isDeferred(d)?d:a.Deferred().resolve()}).fail(function(){b._loadViewModelResult=null,e.log("Load view or action fail, page：{0}.",[b._name])}),this._loadViewModelResult},b.prototype.open=function(b){var c=this;return this._showResult=this.on_preLoad(b).pipe(function(){return c._loadViewModel()}).pipe(function(){return c.on_showing(b),c.on_load(b)}),this._showResult.done(a.proxy(function(){c._hideResult=null,a(c.node()).show(),c.on_shown(this.args)},{args:b})),this._showResult},b.prototype.close=function(a){var b=this;return this._hideResult||(this._hideResult=b.on_closing(a).pipe(function(){return b.visible(!1),b.on_closed(a)})),this._hideResult.always(function(){b._hideResult=null})},b}();b.Page=g}(c||(c={}));var c;return function(b){function c(a,b){var c="http://".toLowerCase();if(a.substr(0,c.length).toLowerCase()==c){var d=document.createElement("a");d.setAttribute("href",a),a=decodeURI(d.pathname);var e=h.addRoute(a);return c+d.host+e.interpolate(b)}var e=h.addRoute(a);return e.interpolate(b)}function d(b,c,d){switch(arguments.length){case 0:throw f.argumentNull("func");case 1:if("function"!=typeof arguments[0])throw f.paramTypeError("arguments[0]","Function");d=b,c=b=[];break;case 2:if(d=c,"function"!=typeof d)throw f.paramTypeError("func","Function");if(!a.isArray(b))throw f.paramTypeError("deps","Array");0==b.length?b=c=[]:"function"==typeof b[0]?(c=b,b=[]):c=[]}for(var e=0;e<b.length;e++)if("string"!=typeof b[e])throw f.paramTypeError("deps["+e+"]","string");for(var e=0;e<c.length;e++)if("function"!=typeof c[e])throw f.paramTypeError("filters["+e+"]","function");if(!a.isFunction(d))throw f.paramTypeError("func","function");return define(b,a.proxy(function(){var a=Array.prototype.slice.call(arguments,0),b=this.func,c=this.filters;return{func:function(c){return a.unshift(c),b.apply(b,a)},filters:c}},{func:d,filters:c})),d}var e=b,f=e.Errors,g=e.Utility,h=window.crossroads,i=function(){function d(a,c){if(this._actions={},!a)throw f.argumentNull("routeData");if("object"!=typeof a)throw f.paramTypeError("routeData","object");if(!c)throw f.argumentNull("actionLocationFormater");this._name=a.controller,this._routeData=a,this._actionLocationFormater=c,this._actions={},this.actionCreated=b.Callbacks()}return d.prototype.actionLocationFormater=function(){return this._actionLocationFormater},d.prototype.name=function(){return this._name},d.prototype.getLocation=function(b){if(!b)throw f.argumentNull("actionName");if("string"!=typeof b)throw f.paramTypeError("actionName","String");var d=a.extend(this._routeData,{action:b});return c(this._routeData.actionPath||this.actionLocationFormater(),d)},d.prototype.action=function(b){if(!b)throw f.argumentNull("name");if("string"!=typeof b)throw f.paramTypeError("name","String");var c=this;return this._actions[b]||(this._actions[b]=this._createAction(b).fail(a.proxy(function(){c._actions[this.actionName]=null},{actionName:b}))),this._actions[b]},d.prototype._createAction=function(b){if(!b)throw f.argumentNull("actionName");var c=this,d=this.getLocation(b),h=a.Deferred();return require([d],a.proxy(function(b){b||(console.warn(g.format("加载活动“{1}.{0}”失败，为该活动提供默认的值。",[this.actionName,c.name()])),b={func:function(){}});var d=b.func;if(!a.isFunction(d))throw e.Errors.modelFileExpecteFunction(this.actionName);var f=new j(c,this.actionName,d);c.actionCreated.fire(c,f),this.result.resolve(f)},{actionName:b,result:h}),a.proxy(function(a){console.warn(g.format("加载活动“{1}.{0}”失败，为该活动提供默认的值。",[this.actionName,c.name()]));var b=new j(c,this.actionName,function(){});c.actionCreated.fire(c,b),this.result.resolve(b)},{actionName:b,result:h})),h},d}();b.Controller=i;var j=function(){function b(b,c,d){if(!b)throw f.argumentNull("controller");if(!c)throw f.argumentNull("name");if(!d)throw f.argumentNull("handle");if(!a.isFunction(d))throw f.paramTypeError("handle","Function");this._name=c,this._handle=d}return b.prototype.name=function(){return this._name},b.prototype.execute=function(b){if(!b)throw f.argumentNull("page");if("Page"!=b._type)throw f.paramTypeError("page","Page");var c=this._handle.apply({},[b]);return g.isDeferred(c)?c:a.Deferred().resolve()},b}();b.action=d}(c||(c={})),function(a){var b=function(){function a(a,b,c){this._controller=a,this._view=b,this._routeData=c}return a.prototype.controller=function(){return this._controller},a.prototype.view=function(){return this._view},a.prototype.routeData=function(){return this._routeData},a}();a.ControllerContext=b}(c||(c={})),function(a){var b=a.Errors,c=a,d=function(){function a(a){if(this._controllers={},!a)throw b.argumentNull("actionLocationFormater");this._controllers={},this._actionLocationFormater=a}return a.prototype.controllers=function(){return this._controllers},a.prototype.createController=function(a){if(!a.controller)throw b.routeDataRequireController();return new c.Controller(a,a.actionPath||this.actionLocationFormater())},a.prototype.actionLocationFormater=function(){return this._actionLocationFormater},a.prototype.getController=function(a){if("object"!=typeof a)throw b.paramTypeError("routeData","object");if(!a.controller)throw b.routeDataRequireController();return this._controllers[a.controller]||(this._controllers[a.controller]=this.createController(a)),this._controllers[a.controller]},a}();a.ControllerFactory=d}(c||(c={})),function(a){var b=function(){function a(a,b,c){this._name=a,this._pattern=b,this._defaults=c}return a.prototype.name=function(){return this._name},a.prototype.defaults=function(){return this._defaults},a.prototype.url=function(){return this._pattern},a}();a.Route=b}(c||(c={})),function(b){var c=b,d=b.Errors,e=function(){function e(){this.routeMatched=b.Callbacks(),this._init()}return e.prototype._init=function(){var a=window.crossroads;this._source=a.create(),this._source.ignoreCase=!0,this._source.normalizeFn=a.NORM_AS_OBJECT,this._priority=0},e.prototype.count=function(){return this._source.getNumRoutes()},e.prototype.mapRoute=function(e){e=e||{};var f=e.name,g=e.url,h=e.defaults,i=e.rules||{};if(!f)throw d.argumentNull("name");if(!g)throw d.argumentNull("url");this._priority=this._priority+1;var j=this,k=this._source.addRoute(g,function(b){var c=a.extend(h,b);j.routeMatched.fire([f,c])},this._priority),l=new b.Route(f,g,h);if(l.viewPath=e.viewPath,l.actionPath=e.actionPath,k.rules=i,k.newRoute=l,this[f])throw d.routeExists(f);return this[f]=l,f==c.RouteCollection.defaultRouteName&&(this._defaults=h),l},e.prototype.getRouteData=function(a){var b=this._source.getRouteData(a);if(null==b)throw d.canntParseUrl(a);for(var c={},e=b.route._paramsIds||[],f=0;f<e.length;f++){var g=e[f];c[g]=b.params[0][g]}return c.viewPath=b.route.newRoute.viewPath,c.actionPath=b.route.newRoute.actionPath,c},e.defaultRouteName="default",e}();b.RouteCollection=e}(c||(c={})),function(b){function c(a,b){var c="http://".toLowerCase();if(a.substr(0,c.length).toLowerCase()==c){var d=document.createElement("a");d.setAttribute("href",a),a=decodeURI(d.pathname);var f=e.addRoute(a);return c+d.host+f.interpolate(b)}var f=e.addRoute(a);return f.interpolate(b)}var d=b.Errors,e=window.crossroads,f=function(){function b(a){this._viewLocationFormater=a,this._views=[]}return b.prototype.view=function(b){if("object"!=typeof b)throw d.paramTypeError("routeData","object");if(!b.controller)throw d.routeDataRequireController();if(!b.action)throw d.routeDataRequireAction();var e=this._viewLocationFormater||b.viewPath;if(!e)return a.Deferred().resolve("");var f=c(b.viewPath||e,b),g=b.controller+"_"+b.action;return this._views[g]||(this._views[g]=a.Deferred(),require(["text!"+f],a.proxy(function(a){null!=a?this.deferred.resolve(a):this.deferred.reject()},{deferred:this._views[g]}),a.proxy(function(a){this.deferred.reject(a)},{deferred:this._views[g]}))),this._views[g]},b}();b.ViewFactory=f}(c||(c={})),function(b){var c=b,d=b.Utility,e=b.Errors,f="{controller}/{action}",g="{controller}/{action}",h=function(){function b(b){if(this.pageCreating=c.Callbacks(),this.pageCreated=c.Callbacks(),this.pageShowing=c.Callbacks(),this.pageShown=c.Callbacks(),this._pages={},this._runned=!1,!b)throw e.argumentNull("func");if(!a.isFunction(b))throw e.paramTypeError("func","Function");var d={container:document.body,routes:new c.RouteCollection,actionPath:f,viewPath:g};a.proxy(b,this)(d),this.controllerFactory=new c.ControllerFactory(d.actionPath),this.viewFactory=new c.ViewFactory(d.viewPath),this._pages={},this._stack=[],this._routes=d.routes,this._container=d.container}return b.prototype.on_pageCreating=function(a){this.pageCreating.fire(this,a)},b.prototype.on_pageCreated=function(a){this.pageCreated.fire(this,a)},b.prototype.on_pageShowing=function(a,b){this.pageShowing.fire(this,a,b)},b.prototype.on_pageShown=function(a,b){this.pageShown.fire(a,b)},b.prototype.routes=function(){return this._routes},b.prototype.controller=function(a){if("object"!=typeof a)throw e.paramTypeError("routeData","object");if(!a)throw e.argumentNull("routeData");return this.controllerFactory.getController(a)},b.prototype.action=function(a){if("object"!=typeof a)throw e.paramTypeError("routeData","object");if(!a)throw e.argumentNull("routeData");var b=a.controller;if(!b)throw e.argumentNull("name");if("string"!=typeof b)throw e.routeDataRequireController();var c=a.action;if(!c)throw e.argumentNull("name");if("string"!=typeof c)throw e.routeDataRequireAction();var d=this.controller(a);return d.action(c)},b.prototype.run=function(){if(!this._runned){var b=this,c=function(a){var c=window.location.hash;if(!c)return void d.log("The url is not contains hash.");var e=window.location.arguments||{},f=window.location.container||b._container;window.location.arguments=null,window.location.container=null,(null==window.location.skip||0==window.location.skip)&&b.showPageAt(f,c.substr(1),e),window.location.skip=!1};a.proxy(c,this)(),a(window).bind("hashchange",a.proxy(c,this)),this._runned=!0}},b.prototype.showPageAt=function(b,d,f){if(f=f||{},!b)throw e.argumentNull("element");if(!d)throw e.argumentNull("url");var g=this,h=a(b).data("PageContainer");null==h&&(h=new c.PageContainer(this,b),h.pageCreating.add(function(a,b){g.on_pageCreating(b)}),h.pageCreated.add(function(a,b){g.on_pageCreated(b)}),h.pageShowing.add(function(a,b,c){g.on_pageShowing(b,c)}),h.pageShown.add(function(a,b,c){g.on_pageShown(b,c)}),a(b).data("PageContainer",h));var g=this;return h.showPage(d,f)},b.prototype.showPage=function(a,b){return this.showPageAt(this._container,a,b)},b.prototype.redirect=function(a,b){window.location.arguments=b,window.location.hash=a},b.prototype.back=function(b){var c=a(this._container).data("PageContainer");return null==c?a.Deferred().reject():c.back(b)},b}();b.Application=h}(c||(c={})),window.chitu=c,c});