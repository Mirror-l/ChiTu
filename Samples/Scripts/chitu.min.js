/*! Author: Shu Mai, Contact: ansiboy@163.com */
!function(a){"function"==typeof define&&define.amd?define(["jquery","crossroads","text"],a):"undefined"!=typeof module&&module.exports?module.exports=a(require(["jquery","crossroads","text"])):window.chitu=a($,crossroads)}(function(a,b){return window.chitu=window.chitu||{},function(b){var c=b.Error;b.utility={isType:function(b,d){if(!b)throw c.argumentNull("type");if(!a.isFunction(b))throw c.paramTypeError("type","Function");if(!d)throw c.argumentNull("obj");for(var e in b.prototype)if(void 0===d[e])return!1;return!0},isDeferred:function(a){return null==a?!1:null!=a.pipe&&null!=a.always&&null!=a.done?!0:!1},format:function(b,c){return 1===arguments.length?function(){var c=a.makeArray(arguments);return c.unshift(b),a.validator.format.apply(this,c)}:(arguments.length>2&&c.constructor!==Array&&(c=a.makeArray(arguments).slice(1)),c.constructor!==Array&&(c=[c]),a.each(c,function(a,c){b=b.replace(new RegExp("\\{"+a+"\\}","g"),function(){return c})}),b)},fileName:function(a,b){if(!a)throw c.argumentNull("url");b=b||!0,a=a.replace("http://","/");var d=a.replace(/^.*[\\\/]/,"");if(b===!0){var e=d.split(".");d=e[0]}return d},log:function(a,b){if(window.console){if(null==b)return void console.log(a);var c=this.format.apply(this,arguments);console.log(c)}}}}(chitu),function(a){var b=a.utility;a.Error={argumentNull:function(a){var c=b.format('The argument "{0}" cannt be null.',a);return new Error(c)},modelFileExpecteFunction:function(a){var c=b.format('The eval result of script file "{0}" is expected a function.',a);return new Error(c)},paramTypeError:function(a,c){var d=b.format('The param "{0}" is expected "{1}" type.',a,c);return new Error(d)},viewNodeNotExists:function(a){var c=b.format('The view node "{0}" is not exists.',a);return new Error(c)},pathPairRequireView:function(a){var c=b.format('The view value is required for path pair, but the item with index "{0}" is miss it.',a);return new Error(c)},notImplemented:function(a){var c=b.format('The method "{0}" is not implemented.',a);return new Error(c)},routeExists:function(a){var c=b.format('Route named "{0}" is exists.',a);return new Error(c)},routeResultRequireController:function(a){var c=b.format('The parse result of route "{0}" does not contains controler.',a);return new Error(c)},routeResultRequireAction:function(a){var c=b.format('The parse result of route "{0}" does not contains action.',a);return new Error(c)},ambiguityRouteMatched:function(a,c,d){var e=b.format("Ambiguity route matched, {0} is match in {1} and {2}.",a,c,d);return new Error(e)},noneRouteMatched:function(a){var c=b.format('None route matched with url "{0}".',a),d=new Error(c);return d},emptyStack:function(){return new Error("The stack is empty.")},canntParseUrl:function(a){var c=b.format('Can not parse the url "{0}" to route data.',a);return new Error(c)},routeDataRequireController:function(){var a='The route data does not contains a "controller" file.';return new Error(a)},routeDataRequireAction:function(){var a='The route data does not contains a "action" file.';return new Error(a)}}}(chitu),function(c){var d=c.Error;c.Callbacks=function(a){a="string"==typeof a?optionsCache[a]||createOptions(a):jQuery.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(b=a.memory&&l,c=!0,g=e||0,e=0,f=h.length,d=!0;h&&f>g;g++){var m=h[g].apply(l[0],l[1]);if(null!=m&&l[0].results.push(m),m===!1&&a.stopOnFalse){b=!1;break}}d=!1,h&&(i?i.length&&j(i.shift()):b?h=[]:k.disable())},k={results:[],add:function(){if(h){var c=h.length;!function g(b){jQuery.each(b,function(b,c){var d=jQuery.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&g(c)})}(arguments),d?f=h.length:b&&(e=c,j(b))}return this},remove:function(){return h&&jQuery.each(arguments,function(a,b){for(var c;(c=jQuery.inArray(b,h,c))>-1;)h.splice(c,1),d&&(f>=c&&f--,g>=c&&g--)}),this},has:function(a){return a?jQuery.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],f=0,this},disable:function(){return h=i=b=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,b||k.disable(),this},locked:function(){return!i},fireWith:function(a,b){return a.results=[],!h||c&&!i||(b=b||[],b=[a,b.slice?b.slice():b],d?i.push(b):j(b)),a.results},fire:function(){return k.fireWith(this,arguments)},fired:function(){return!!c}};return k},c.fireCallback=function(b,c){for(var d=b.fire.apply(b,c)||[],e=[],f=0;f<d.length;f++)chitu.utility.isDeferred(d[f])&&e.push(d[f]);return 0==e.length?a.Deferred().resolve():a.when.apply(a,e)},a.extend(b,{_create:b.create,create:function(){var a=this._create();return a.getRouteData=function(a,b){if(a=a||"",b=b||[],this.ignoreState||a!==this._prevMatchedRequest&&a!==this._prevBypassedRequest){var c=this._getMatchedRoutes(a),e=c.length;if(0==e)return null;if(e>1)throw d.ambiguityRouteMatched(a,"route1","route2");return c[0]}},a}})}(chitu),function(b){b.PageContainer=function(a,c){this.pageCreating=b.Callbacks(),this.pageCreated=b.Callbacks(),this.pageShowing=b.Callbacks(),this.pageShown=b.Callbacks(),this.init(a,c)},b.PageContainer.prototype={init:function(a,b){this._app=a,this._node=b,this._pageStack=[]},on_pageCreating:function(a){return b.fireCallback(this.pageCreating,[this,a])},on_pageCreated:function(a){return b.fireCallback(this.pageCreated,[this,a])},on_pageShowing:function(a,c){return b.fireCallback(this.pageShowing,[this,a,c])},on_pageShown:function(a,c){return b.fireCallback(this.pageShown,[this,a,c])},application:function(){return this._app},node:function(){return this._node},currentPage:function(){return this._currentPage},_createPage:function(a,c){if(!a)throw e.argumentNull("url");if("string"!=typeof a)throw e.paramTypeError("url","String");c||(c=document.createElement("div"),document.body.appendChild(c));var d=this.application().routes().getRouteData(a);if(null==d)throw e.noneRouteMatched(a);var f=d.controller,g=d.action,h=this.application().controller(d),i=this.application().viewEngineFactory.getViewEngine(f).view(g),j=new b.ControllerContext(h,i,d);this.on_pageCreating(j);var k=new b.Page(j,c);return this.on_pageCreated(k),k},showPage:function(b,c){if(c=c||{},!b)throw e.argumentNull("url");var d=this.application().routes().getRouteData(b);if(null==d)throw e.noneRouteMatched(b);var f=this.node(),g=d.controller,h=d.action,i=g+"."+h,j=a(f).data("pages");j||(j={},a(f).data("pages",j));var k=this,l=j[i];if(null==l){var m=a("<div>").appendTo(f)[0];l=this._createPage(b,m),j[i]=l}this._currentPage=l;for(var i in j)j[i]!=this._currentPage&&j[i].visible(!1);a.extend(c,d);var k=this,n=a.Deferred();return this.on_pageShowing(l,c).pipe(function(){return l.open(c)}).done(a.proxy(function(){k._pageStack.push({page:this.page,url:this.url}),this.page!=k.currentPage()&&this.page.visible(!1),this.result.resolve(this.page),k.on_pageShown(this.page,c)},{page:l,result:n,url:b})).fail(a.proxy(function(a){this.result.reject(this.page,a)},{page:l,result:n,url:b})),n},back:function(b){var c=this._pageStack,d=this.currentPage();if(0==c.length||null==d)return a.Deferred().reject();c.pop();var e=c[c.length-1];if(null==e)return a.Deferred().reject();var f="#"+e.url.toLowerCase();return 0!=f.localeCompare(window.location.hash.toLowerCase())&&(window.location.hash=e.url,window.location.skip=!0),d.visible(!1),b?e.page.open(b):e.page.visible(!0),this._currentPage=e.page,a.Deferred().resolve()}}}(chitu),function(b){function c(a,b,c){return chitu.fireCallback(a,[b,c])}var d=chitu.utility,e=chitu.Error;b.Page=function(a,c){if(!a)throw e.argumentNull("context");if("ControllerContext"!=a._type)throw e.paramTypeError("context","ControllerContext");if(!c)throw e.argumentNull("node");this.created=b.Callbacks(),this.preLoad=b.Callbacks(),this.load=b.Callbacks(),this.closing=b.Callbacks(),this.closed=b.Callbacks(),this.scroll=b.Callbacks(),this.showing=b.Callbacks(),this.shown=b.Callbacks(),this.hiding=b.Callbacks(),this.hidden=b.Callbacks(),this._context=a;var d=a.routeData().controller,f=a.routeData().action,g=d+"."+f,h=a.view(),i=a.controller().action(f);this.init(g,h,i,c)},b.Page.prototype={_type:"Page",context:function(){return this._context},name:function(){return this._name},node:function(){return this._node},parent:function(){return this._parent},visible:function(b){var c=a(this.node()).is(":visible");return void 0===b?c:void(b!=c&&(b?(this.on_showing({}),a(this.node()).show(),this.on_shown({})):(this.on_hiding({}),a(this.node()).hide(),this.on_hidden({})),this._visible=b))},init:function(b,c,d,f){if(!b)throw e.argumentNull("name");if(!c)throw e.argumentNull("viewDeferred");if(!d)throw e.argumentNull("actionDeferred");if(!f)throw e.argumentNull("node");this._name=b,this._viewDeferred=c,this._actionDeferred=d,this._parent,this._node=f,this._visible=!0,a(this._node).hide()},on_creating:function(a){return c(this.creating,this,a)},on_created:function(){return c(this.created,this)},on_preLoad:function(a){return c(this.preLoad,this,a)},on_load:function(a){return c(this.load,this,a)},on_closing:function(a){return c(this.closing,this,a)},on_closed:function(a){return c(this.closed,this,a)},on_scroll:function(a){return c(this.scroll,this,a)},on_showing:function(a){return c(this.showing,this,a)},on_shown:function(a){return c(this.shown,this,a)},on_hiding:function(a){return c(this.hiding,this,a)},on_hidden:function(a){return c(this.hidden,this,a)},_nodeOriginalVisible:[],_appendNode:function(b){if(null==b)throw e.argumentNull("childNode");a(this._node).append(b)},_bindModel:function(a){if(!ko)return void d.log("The knockout js is not loaded.");if(!a)throw e.argumentNull("model");ko.cleanNode(this.node()),ko.applyBindings(a,this.node())},_loadViewModel:function(){if(this._loadViewModelResult)return this._loadViewModelResult;var b=this;return this._loadViewModelResult=this._viewDeferred.pipe(function(c){return d.log("Load view success, page:{0}.",b._name),a(b.node()).html(c),b._actionDeferred}).pipe(function(c){var e=c.execute(b);return b.on_created(),d.isDeferred(e)?e:a.Deferred().resolve()}).fail(function(){b._loadViewModelResult=null,d.log("Load view or action fail, page：{0}.",b._name)}),this._loadViewModelResult},open:function(b){var c=this;return this._showResult=this.on_preLoad(b).pipe(function(){return c._loadViewModel()}).pipe(function(){return c.on_showing(b),c.on_load(b)}),this._showResult.done(a.proxy(function(){c._hideResult=null,a(c.node()).show(),c.on_shown(this.args)},{args:b})),this._showResult},close:function(a){var b=this;return this._hideResult||(this._hideResult=b.on_closing(a).pipe(function(){return b.visible(!1),b.on_closed(a)})),this._hideResult.always(function(){b._hideResult=null})},model:function(a){return void 0===a?this._model:(this._model=a,void this._bindModel(this._model))}}}(chitu),function(c){var d=c.Error,e=c.utility;c.Controller=function(a,c){if(!a)throw d.argumentNull("routeData");if("object"!=typeof a)throw d.paramTypeError("routeData","object");if(!c)throw d.argumentNull("actionLocationFormater");this._name=a.controller,this._routeData=a,this._actionLocationFormater=c,this._actions={},this._actionLocationRoute=b.addRoute(c),this.actionCreated=chitu.Callbacks()},c.Controller.prototype={actionLocationFormater:function(){return this._actionLocationFormater},name:function(){return this._name},getLocation:function(b){if(!b)throw d.argumentNull("actionName");if("string"!=typeof b)throw d.paramTypeError("actionName","String");var c=a.extend({action:b},this._routeData);return this._actionLocationRoute.interpolate(c)},action:function(b){if(!b)throw d.argumentNull("name");if("string"!=typeof b)throw d.paramTypeError("name","String");var c=this;return this._actions[b]||(this._actions[b]=this._createAction(b).fail(a.proxy(function(){c._actions[this.actionName]=null},{actionName:b}))),this._actions[b]},_createAction:function(b){if(!b)throw d.argumentNull("actionName");var f=this,g=this.getLocation(b),h=a.Deferred();return require([g],a.proxy(function(b){b||(console.warn(e.format("加载活动“{1}.{0}”失败，为该活动提供默认的值。",this.actionName,f.name())),b={func:function(){}});var d=b.func;if(!a.isFunction(d))throw c.Error.modelFileExpecteFunction(this.actionName);var g=new c.Action(f,this.actionName,d);f.actionCreated.fire(f,g),this.result.resolve(g)},{actionName:b,result:h}),a.proxy(function(a){this.result.reject(a)},{actionName:b,result:h})),h}},c.ControllerFactory=function(a){if(!a)throw d.argumentNull("actionLocationFormater");this._controllers={},this._actionLocationFormater=a},c.ControllerFactory.prototype={controllers:function(){return this._controllers},createController:function(a){if(!a.controller)throw d.routeDataRequireController();return new c.Controller(a,this.actionLocationFormater())},actionLocationFormater:function(){return this._actionLocationFormater},getController:function(a){if("object"!=typeof a)throw d.paramTypeError("routeData","object");if(!a.controller)throw d.routeDataRequireController();return this._controllers[a.controller]||(this._controllers[a.controller]=this.createController(a)),this._controllers[a.controller]}},c.Action=function(b,c,e){if(!b)throw d.argumentNull("controller");if(!c)throw d.argumentNull("name");if(!e)throw d.argumentNull("handle");if(!a.isFunction(e))throw d.paramTypeError("handle","Function");this._name=c,this._handle=e},c.Action.prototype={name:function(){return this._name},execute:function(b){if(!b)throw d.argumentNull("page");if("Page"!=b._type)throw d.paramTypeError("page","Page");var f=this._handle.apply(c.app,[b]);return e.isDeferred(f)?f:a.Deferred().resolve()}},c.ViewEngine=function(a,c){if(!a)throw d.argumentNull("controllerName");if(!c)throw d.argumentNull("viewLocationFormater");this._controllerName=a,this._viewLocationFormater=c,this._viewLocationRoute=b.addRoute(c),this._views={}},c.ViewEngine.prototype={viewFileExtension:"html",viewLocationFormater:function(){return this._viewLocationFormater},controllerName:function(){return this._controllerName},getLocation:function(a){var b=this._controllerName;return this._viewLocationRoute.interpolate({controller:b,action:a})+"."+this.viewFileExtension},view:function(a){return this._getView(a)},_getView:function(b){var c=this.getLocation(b);return this._views[b]||(this._views[b]=a.Deferred(),require(["text!"+c],a.proxy(function(a){null!=a?this.deferred.resolve(a):this.deferred.reject()},{deferred:this._views[b]}),a.proxy(function(a){this.deferred.reject(a)},{deferred:this._views[b]}))),this._views[b]}},c.ViewEngineFacotry=function(a){if(!a)throw d.argumentNull("viewLocationFormater");this._viewLocationFormater=a},c.ViewEngineFacotry.prototype={viewEngines:{},viewLocationFormater:function(){return this._viewLocationFormater},createViewEngine:function(a){return new c.ViewEngine(a,this.viewLocationFormater())},getViewEngine:function(a){return this.viewEngines[a]||(this.viewEngines[a]=this.createViewEngine(a)),this.viewEngines[a]}},c.action=c.register=function(b,c,e){switch(arguments.length){case 0:throw d.argumentNull("func");case 1:if("function"!=typeof arguments[0])throw d.paramTypeError("arguments[0]","Function");e=b,c=b=[];break;case 2:if(e=c,"function"!=typeof e)throw d.paramTypeError("func","Function");if(!a.isArray(b))throw d.paramTypeError("deps","Array");0==b.length?b=c=[]:"function"==typeof b[0]?(c=b,b=[]):c=[]}for(var f=0;f<b.length;f++)if("string"!=typeof b[f])throw d.paramTypeError("deps["+f+"]","string");for(var f=0;f<c.length;f++)if("function"!=typeof c[f])throw d.paramTypeError("filters["+f+"]","function");if(!a.isFunction(e))throw d.paramTypeError("func","function");return define(b,a.proxy(function(){var a=Array.prototype.slice.call(arguments,0),b=this.func,c=this.filters;return{func:function(c){return a.unshift(c),b.apply(b,a)},filters:c}},{func:e,filters:c})),e},c.ControllerContext=function(a,b,c){this._controller=a,this._view=b,this._routeData=c},c.ControllerContext.prototype={_type:"ControllerContext",controller:function(){return this._controller},view:function(){return this._view},routeData:function(){return this._routeData}}}(chitu),function(c){var d=(c.utility,c.Error);c.Route=function(a,b,c,d){this.init(b,c,d)},c.Route.prototype={init:function(a,b,c){this._name=a,this._defaults=c,this._url=b},name:function(){return this._name},defaults:function(){return this._defaults},url:function(){return this._url}},c.RouteCollection=function(){this._init()},c.RouteCollection.defaultRouteName="default",c.RouteCollection.prototype={_defaults:{},_routeHadle:function(b){var c=this.route,d=this.routes,e=a.extend(c.defaults(),b);if(!e.controller)throw new Error("The parse result of route does not contains controler.");d.routeMatched.fire(c.name(),e)},_init:function(){this._source=b.create(),this._source.ignoreCase=!0,this._source.normalizeFn=b.NORM_AS_OBJECT,this._priority=0},count:function(){return this._source.getNumRoutes()},routeMatched:a.Callbacks(),mapRoute:function(b){b=b||{};var e=b.name,f=b.url,g=b.defaults,h=b.rules||{};if(!e)throw d.argumentNull("name");if(!f)throw d.argumentNull("url");this._priority=this._priority+1;var i=this,j=this._source.addRoute(f,function(b){var c=a.extend(g,b);i.routeMatched.fire(e,c)},this._priority),k=new chitu.Route(j,e,f,g);if(j.rules=h,j.newRoute=k,this[e])throw d.routeExists(e);return this[e]=k,e==c.RouteCollection.defaultRouteName&&(this._defaults=g),k},getRouteData:function(a){var b=this._source.getRouteData(a);if(null==b)throw d.canntParseUrl(a);for(var c={},e=b.route._paramsIds||[],f=0;f<e.length;f++){var g=e[f];c[g]=b.params[0][g]}return c},getUrl:function(a,b){}}}(chitu),function(b){var c=b.utility,d=b.Error,e="{controller}/{action}",f="{controller}/{action}";b.Application=function(c){if(!c)throw d.argumentNull("func");if(!a.isFunction(c))throw d.paramTypeError("func","Function");var g={container:document.body,routes:new b.RouteCollection,actionPath:e,viewPath:f,viewFileExtension:"html"};a.proxy(c,this)(g),this.controllerFactory=new b.ControllerFactory(g.actionPath),this.viewEngineFactory=new b.ViewEngineFacotry(g.viewPath),this._pages={},this._stack=[],this._routes=g.routes,this._container=g.container,this.pageCreating=b.Callbacks(),this.pageCreated=b.Callbacks(),this.pageShowing=b.Callbacks(),this.pageShown=b.Callbacks()},b.Application.prototype={on_pageCreating:function(a){this.pageCreating.fire(this,a)},on_pageCreated:function(a){this.pageCreated.fire(this,a)},on_pageShowing:function(a,b){this.pageShowing.fire(this,a,b)},on_pageShown:function(a,b){this.pageShown.fire(this,a,b)},routes:function(){return this._routes},controller:function(a){if("object"!=typeof a)throw d.paramTypeError("routeData","object");if(!a)throw d.argumentNull("routeData");return this.controllerFactory.getController(a)},action:function(a){if("object"!=typeof a)throw d.paramTypeError("routeData","object");if(!a)throw d.argumentNull("routeData");var b=a.controller;if(!b)throw d.argumentNull("name");if("string"!=typeof b)throw d.routeDataRequireController();var c=a.action;if(!c)throw d.argumentNull("name");if("string"!=typeof c)throw d.routeDataRequireAction();var e=this.controller(a);return e.action(c)},run:function(){if(!this._runned){var b=this,d=function(a){var d=window.location.hash;if(!d)return void c.log("The url is not contains hash.");var e=window.location.arguments||{},f=window.location.container||b._container;window.location.arguments=null,window.location.container=null,(null==window.location.skip||0==window.location.skip)&&b.showPageAt(f,d.substr(1),e),window.location.skip=!1};a.proxy(d,this)(),a(window).bind("hashchange",a.proxy(d,this)),this._runned=!0}},showPageAt:function(c,e,f){if(f=f||{},!c)throw d.argumentNull("element");if(!e)throw d.argumentNull("url");var g=this,h=a(c).data("PageContainer");null==h&&(h=new b.PageContainer(this,c),h.pageCreating.add(function(a,b){g.on_pageCreating(b)}),h.pageCreated.add(function(a,b){g.on_pageCreated(b)}),h.pageShowing.add(function(a,b,c){g.on_pageShowing(b,c)}),h.pageShown.add(function(a,b,c){g.on_pageShown(b,c)}),a(c).data("PageContainer",h));var g=this;return h.showPage(e,f)},showPage:function(a,b){return this.showPageAt(this._container,a,b)},redirect:function(a,b){window.location.arguments=b,window.location.hash=a},back:function(b){var c=a(this._container).data("PageContainer");return null==c?a.Deferred().reject():c.back(b)}}}(chitu),chitu});