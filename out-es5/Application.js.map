{"version":3,"sources":["../out/Application.js"],"names":["define","require","exports","maishu_chitu_service_1","PageMaster_1","Errors_1","Object","defineProperty","value","DefaultPageName","parseUrl","url","Errors","argumentNull","sharpIndex","indexOf","routeString","substr","canntParseRouteString","startsWith","routePath","search","param_spliter_index","substring","values","pareeUrlQuery","pageName","query","match","pl","decode","s","decodeURIComponent","replace","urlParams","exec","createPageUrl","params","path_parts","split","path","join","paramsText","key","encodeURI","Application","args","containers","container","parser","_runned","routeData","showPage","location","href","window","addEventListener","skip","pageUrl","hash","containerName","DefaultContainerName","page","openPage","createUrl","name","data","setLocationHash","setUrl","result","closeCurrentPage","setTimeout","history","back","type","Service","service","error","add","sender","fire","r","document","body","tagName","containerIsNotExists","PageMaster"],"mappings":"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","sourcesContent":["define([\"require\", \"exports\", \"maishu-chitu-service\", \"./PageMaster\", \"./Errors\"], function (require, exports, maishu_chitu_service_1, PageMaster_1, Errors_1) {\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    const DefaultPageName = \"index\";\r\n    function parseUrl(url) {\r\n        if (!url)\r\n            throw Errors_1.Errors.argumentNull('url');\r\n        let sharpIndex = url.indexOf('#');\r\n        let routeString;\r\n        if (sharpIndex >= 0)\r\n            routeString = url.substr(sharpIndex + 1);\r\n        else\r\n            routeString = url;\r\n        if (!routeString)\r\n            throw Errors_1.Errors.canntParseRouteString(url);\r\n        if (routeString.startsWith('!')) {\r\n            throw Errors_1.Errors.canntParseRouteString(routeString);\r\n        }\r\n        let routePath;\r\n        let search = null;\r\n        let param_spliter_index = routeString.indexOf('?');\r\n        if (param_spliter_index >= 0) {\r\n            search = routeString.substr(param_spliter_index + 1);\r\n            routePath = routeString.substring(0, param_spliter_index);\r\n        }\r\n        else {\r\n            routePath = routeString;\r\n        }\r\n        if (!routePath)\r\n            routePath = DefaultPageName;\r\n        let values = {};\r\n        if (search) {\r\n            values = pareeUrlQuery(search);\r\n        }\r\n        let pageName = routePath;\r\n        return { pageName, values };\r\n    }\r\n    exports.parseUrl = parseUrl;\r\n    function pareeUrlQuery(query) {\r\n        let match, pl = /\\+/g, search = /([^&=]+)=?([^&]*)/g, decode = function (s) { return decodeURIComponent(s.replace(pl, \" \")); };\r\n        let urlParams = {};\r\n        while (match = search.exec(query))\r\n            urlParams[decode(match[1])] = decode(match[2]);\r\n        return urlParams;\r\n    }\r\n    function createPageUrl(pageName, params) {\r\n        let path_parts = pageName.split('.');\r\n        let path = path_parts.join('/');\r\n        if (!params)\r\n            return `${path}`;\r\n        let paramsText = '';\r\n        for (let key in params) {\r\n            let value = params[key];\r\n            if (typeof value == \"function\" || value == null)\r\n                continue;\r\n            value = encodeURI(value);\r\n            paramsText = paramsText == '' ? `?${key}=${value}` : paramsText + `&${key}=${value}`;\r\n        }\r\n        return `${path}${paramsText}`;\r\n    }\r\n    exports.createPageUrl = createPageUrl;\r\n    class Application extends PageMaster_1.PageMaster {\r\n        constructor(args) {\r\n            super(Application.containers((args || {}).container), (args || {}).parser);\r\n            this._runned = false;\r\n        }\r\n        static containers(container) {\r\n            let r = {};\r\n            if (container == null) {\r\n                r[Application.DefaultContainerName] = document.body;\r\n                return r;\r\n            }\r\n            if (container.tagName) {\r\n                r[Application.DefaultContainerName] = container;\r\n                return r;\r\n            }\r\n            r = container;\r\n            if (!Application.DefaultContainerName)\r\n                throw Errors_1.Errors.containerIsNotExists(Application.DefaultContainerName);\r\n            return r;\r\n        }\r\n        parseUrl(url) {\r\n            if (!url)\r\n                throw Errors_1.Errors.argumentNull('url');\r\n            let routeData = parseUrl(url);\r\n            return routeData;\r\n        }\r\n        createUrl(pageName, values) {\r\n            return createPageUrl(pageName, values);\r\n        }\r\n        run() {\r\n            if (this._runned)\r\n                return;\r\n            let showPage = () => {\r\n                let url = location.href;\r\n                let sharpIndex = url.indexOf('#');\r\n                if (sharpIndex < 0) {\r\n                    url = '#' + DefaultPageName;\r\n                }\r\n                else {\r\n                    url = url.substr(sharpIndex + 1);\r\n                }\r\n                if (url.startsWith('!')) {\r\n                    return;\r\n                }\r\n                this.showPage(url);\r\n            };\r\n            showPage();\r\n            window.addEventListener('hashchange', () => {\r\n                if (this.location.skip) {\r\n                    delete this.location.skip;\r\n                    return;\r\n                }\r\n                showPage();\r\n            });\r\n            this._runned = true;\r\n        }\r\n        setLocationHash(pageUrl) {\r\n            this.location.hash = `#${pageUrl}`;\r\n            this.location.skip = true;\r\n        }\r\n        get location() {\r\n            return location;\r\n        }\r\n        redirect(pageUrl, args) {\r\n            if (!pageUrl)\r\n                throw Errors_1.Errors.argumentNull('pageUrl');\r\n            let routeData = parseUrl(pageUrl);\r\n            let containerName = routeData.values.container || Application.DefaultContainerName;\r\n            let page = this.openPage(pageUrl, containerName, args);\r\n            let url = this.createUrl(page.name, page.data);\r\n            this.setLocationHash(url);\r\n            return page;\r\n        }\r\n        forward(pageUrl, args, setUrl) {\r\n            if (!pageUrl)\r\n                throw Errors_1.Errors.argumentNull('pageNameOrUrl');\r\n            if (setUrl == null)\r\n                setUrl = true;\r\n            let routeData = parseUrl(pageUrl);\r\n            let containerName = routeData.values.container || Application.DefaultContainerName;\r\n            let page = this.openPage(pageUrl, containerName, args, true);\r\n            if (setUrl) {\r\n                let url = this.createUrl(page.name, page.data);\r\n                this.setLocationHash(url);\r\n            }\r\n            return page;\r\n        }\r\n        reload(pageName, args) {\r\n            let result = this.showPage(pageName, args, true);\r\n            return result;\r\n        }\r\n        back() {\r\n            this.closeCurrentPage();\r\n            setTimeout(() => {\r\n                history.back();\r\n            }, 100);\r\n        }\r\n        createService(type) {\r\n            type = type || maishu_chitu_service_1.Service;\r\n            let service = new type();\r\n            service.error.add((sender, error) => {\r\n                this.error.fire(this, error, null);\r\n            });\r\n            return service;\r\n        }\r\n    }\r\n    Application.DefaultContainerName = 'default';\r\n    exports.Application = Application;\r\n});\r\n"],"file":"Application.js"}