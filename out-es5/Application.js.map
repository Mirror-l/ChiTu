{"version":3,"sources":["../out/Application.js"],"names":["define","require","exports","maishu_chitu_service_1","PageMaster_1","Errors_1","Object","defineProperty","value","DefaultPageName","parseUrl","url","Errors","argumentNull","sharpIndex","indexOf","routeString","substr","canntParseRouteString","startsWith","routePath","search","param_spliter_index","substring","values","pareeUrlQuery","pageName","query","match","pl","decode","s","decodeURIComponent","replace","urlParams","exec","createPageUrl","params","path_parts","split","path","join","paramsText","key","type","Application","args","container","document","body","parser","_runned","closeCurrentOnBack","tempPageData","undefined","routeData","showPage","location","href","showPageByUrl","window","addEventListener","skip","fetchTemplatePageData","result","closeCurrentPage","currentPage","page","pageStack","pop","Error","hide","data","pageUrl","hash","createUrl","name","setLocationHash","setUrl","closeCurrentPageDefault","history","back","Service","service","error","add","sender","fire","PageMaster"],"mappings":"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","sourcesContent":["define([\"require\", \"exports\", \"maishu-chitu-service\", \"./PageMaster\", \"./Errors\"], function (require, exports, maishu_chitu_service_1, PageMaster_1, Errors_1) {\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    const DefaultPageName = \"index\";\r\n    function parseUrl(url) {\r\n        if (!url)\r\n            throw Errors_1.Errors.argumentNull('url');\r\n        let sharpIndex = url.indexOf('#');\r\n        let routeString;\r\n        if (sharpIndex >= 0)\r\n            routeString = url.substr(sharpIndex + 1);\r\n        else\r\n            routeString = url;\r\n        if (!routeString)\r\n            throw Errors_1.Errors.canntParseRouteString(url);\r\n        if (routeString.startsWith('!')) {\r\n            throw Errors_1.Errors.canntParseRouteString(routeString);\r\n        }\r\n        let routePath;\r\n        let search = null;\r\n        let param_spliter_index = routeString.indexOf('?');\r\n        if (param_spliter_index >= 0) {\r\n            search = routeString.substr(param_spliter_index + 1);\r\n            routePath = routeString.substring(0, param_spliter_index);\r\n        }\r\n        else {\r\n            routePath = routeString;\r\n        }\r\n        if (!routePath)\r\n            routePath = DefaultPageName;\r\n        let values = {};\r\n        if (search) {\r\n            values = pareeUrlQuery(search);\r\n        }\r\n        let pageName = routePath;\r\n        return { pageName, values };\r\n    }\r\n    exports.parseUrl = parseUrl;\r\n    function pareeUrlQuery(query) {\r\n        let match, pl = /\\+/g, search = /([^&=]+)=?([^&]*)/g, decode = function (s) { return decodeURIComponent(s.replace(pl, \" \")); };\r\n        let urlParams = {};\r\n        while (match = search.exec(query))\r\n            urlParams[decode(match[1])] = decode(match[2]);\r\n        return urlParams;\r\n    }\r\n    function createPageUrl(pageName, params) {\r\n        let path_parts = pageName.split('.');\r\n        let path = path_parts.join('/');\r\n        if (!params)\r\n            return `${path}`;\r\n        let paramsText = '';\r\n        for (let key in params) {\r\n            let value = params[key];\r\n            let type = typeof params[key];\r\n            if (type != 'string' || value == null) {\r\n                continue;\r\n            }\r\n            paramsText = paramsText == '' ? `?${key}=${params[key]}` : paramsText + `&${key}=${params[key]}`;\r\n        }\r\n        return `${path}${paramsText}`;\r\n    }\r\n    class Application extends PageMaster_1.PageMaster {\r\n        constructor(args) {\r\n            super((args || {}).container || document.body, (args || {}).parser);\r\n            this._runned = false;\r\n            this.closeCurrentOnBack = null;\r\n            this.tempPageData = undefined;\r\n        }\r\n        parseUrl(url) {\r\n            if (!url)\r\n                throw Errors_1.Errors.argumentNull('url');\r\n            let routeData = parseUrl(url);\r\n            return routeData;\r\n        }\r\n        createUrl(pageName, values) {\r\n            return createPageUrl(pageName, values);\r\n        }\r\n        run() {\r\n            if (this._runned)\r\n                return;\r\n            let showPage = () => {\r\n                let url = location.href;\r\n                let sharpIndex = url.indexOf('#');\r\n                let routeString = url.substr(sharpIndex + 1);\r\n                if (routeString.startsWith('!')) {\r\n                    return;\r\n                }\r\n                if (sharpIndex < 0) {\r\n                    url = '#' + DefaultPageName;\r\n                }\r\n                this.showPageByUrl(url);\r\n            };\r\n            showPage();\r\n            window.addEventListener('hashchange', () => {\r\n                if (this.location.skip) {\r\n                    delete this.location.skip;\r\n                    return;\r\n                }\r\n                showPage();\r\n            });\r\n            this._runned = true;\r\n        }\r\n        showPageByUrl(url) {\r\n            if (!url)\r\n                throw Errors_1.Errors.argumentNull('url');\r\n            let tempPageData = this.fetchTemplatePageData();\r\n            let result = null;\r\n            if (this.closeCurrentOnBack == true) {\r\n                this.closeCurrentOnBack = null;\r\n                if (tempPageData == null)\r\n                    this.closeCurrentPage();\r\n                else\r\n                    this.closeCurrentPage(tempPageData);\r\n                result = this.currentPage;\r\n            }\r\n            else if (this.closeCurrentOnBack == false) {\r\n                this.closeCurrentOnBack = null;\r\n                var page = this.pageStack.pop();\r\n                if (page == null)\r\n                    throw new Error('page is null');\r\n                page.hide(this.currentPage);\r\n                result = this.currentPage;\r\n            }\r\n            if (result == null || result.url != url) {\r\n                result = this.showPage(url);\r\n            }\r\n            return result;\r\n        }\r\n        fetchTemplatePageData() {\r\n            if (this.tempPageData == null) {\r\n                return null;\r\n            }\r\n            let data = this.tempPageData;\r\n            this.tempPageData = undefined;\r\n            return data;\r\n        }\r\n        setLocationHash(pageUrl) {\r\n            this.location.hash = `#${pageUrl}`;\r\n            this.location.skip = true;\r\n        }\r\n        get location() {\r\n            return location;\r\n        }\r\n        redirect(pageUrl, args) {\r\n            if (!pageUrl)\r\n                throw Errors_1.Errors.argumentNull('pageUrl');\r\n            let page = this.showPage(pageUrl, args);\r\n            let url = this.createUrl(page.name, page.data);\r\n            this.setLocationHash(url);\r\n            return page;\r\n        }\r\n        forward(pageUrl, args, setUrl) {\r\n            if (!pageUrl)\r\n                throw Errors_1.Errors.argumentNull('pageNameOrUrl');\r\n            if (setUrl == null)\r\n                setUrl = true;\r\n            let page = this.showPage(pageUrl, args, true);\r\n            if (setUrl) {\r\n                let url = this.createUrl(page.name, page.data);\r\n                this.setLocationHash(url);\r\n            }\r\n            return page;\r\n        }\r\n        reload(pageName, args) {\r\n            let result = this.showPage(pageName, args, true);\r\n            return result;\r\n        }\r\n        back(closeCurrentPage, data) {\r\n            const closeCurrentPageDefault = true;\r\n            if (typeof closeCurrentPage == 'object') {\r\n                data = closeCurrentPage;\r\n                closeCurrentPage = null;\r\n            }\r\n            this.closeCurrentOnBack = closeCurrentPage == null ? closeCurrentPageDefault : closeCurrentPage;\r\n            this.tempPageData = data;\r\n            history.back();\r\n        }\r\n        createService(type) {\r\n            type = type || maishu_chitu_service_1.Service;\r\n            let service = new type();\r\n            service.error.add((sender, error) => {\r\n                this.error.fire(this, error, null);\r\n            });\r\n            return service;\r\n        }\r\n    }\r\n    exports.Application = Application;\r\n});\r\n"],"file":"Application.js"}