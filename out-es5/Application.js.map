{"version":3,"sources":["../out/Application.js"],"names":["define","require","exports","maishu_chitu_service_1","PageMaster_1","Errors_1","Object","defineProperty","value","EmtpyStateData","DefaultPageName","parseUrl","url","Errors","argumentNull","sharpIndex","indexOf","routeString","substr","canntParseRouteString","startsWith","routePath","search","param_spliter_index","substring","values","pareeUrlQuery","pageName","query","match","pl","decode","s","decodeURIComponent","replace","urlParams","exec","createUrl","params","path_parts","split","path","join","paramsText","key","type","Application","args","container","document","body","parser","_runned","closeCurrentOnBack","tempPageData","undefined","routeData","showPage","location","href","showPageByUrl","window","addEventListener","fetchTemplatePageData","result","closeCurrentPage","currentPage","page","pageStack","pop","Error","hide","data","history","pushState","pageNameOrUrl","showPageByNameOrUrl","name","setLocationHash","setUrl","rerender","obj","assign","closeCurrentPageDefault","back","Service","service","error","add","sender","fire","PageMaster"],"mappings":"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","sourcesContent":["define([\"require\", \"exports\", \"maishu-chitu-service\", \"./PageMaster\", \"./Errors\"], function (require, exports, maishu_chitu_service_1, PageMaster_1, Errors_1) {\n    \"use strict\";\n    Object.defineProperty(exports, \"__esModule\", { value: true });\n    const EmtpyStateData = \"\";\n    const DefaultPageName = \"index\";\n    function parseUrl(url) {\n        if (!url)\n            throw Errors_1.Errors.argumentNull('url');\n        let sharpIndex = url.indexOf('#');\n        let routeString;\n        if (sharpIndex >= 0)\n            routeString = url.substr(sharpIndex + 1);\n        else\n            routeString = url;\n        if (!routeString)\n            throw Errors_1.Errors.canntParseRouteString(url);\n        if (routeString.startsWith('!')) {\n            throw Errors_1.Errors.canntParseRouteString(routeString);\n        }\n        let routePath;\n        let search = null;\n        let param_spliter_index = routeString.indexOf('?');\n        if (param_spliter_index >= 0) {\n            search = routeString.substr(param_spliter_index + 1);\n            routePath = routeString.substring(0, param_spliter_index);\n        }\n        else {\n            routePath = routeString;\n        }\n        if (!routePath)\n            routePath = DefaultPageName;\n        let values = {};\n        if (search) {\n            values = pareeUrlQuery(search);\n        }\n        let pageName = routePath;\n        return { pageName, values };\n    }\n    exports.parseUrl = parseUrl;\n    function pareeUrlQuery(query) {\n        let match, pl = /\\+/g, search = /([^&=]+)=?([^&]*)/g, decode = function (s) { return decodeURIComponent(s.replace(pl, \" \")); };\n        let urlParams = {};\n        while (match = search.exec(query))\n            urlParams[decode(match[1])] = decode(match[2]);\n        return urlParams;\n    }\n    function createUrl(pageName, params) {\n        let path_parts = pageName.split('.');\n        let path = path_parts.join('/');\n        if (!params)\n            return `#${path}`;\n        let paramsText = '';\n        for (let key in params) {\n            let value = params[key];\n            let type = typeof params[key];\n            if (type != 'string' || value == null) {\n                continue;\n            }\n            paramsText = paramsText == '' ? `?${key}=${params[key]}` : paramsText + `&${key}=${params[key]}`;\n        }\n        return `#${path}${paramsText}`;\n    }\n    class Application extends PageMaster_1.PageMaster {\n        constructor(args) {\n            super((args || {}).container || document.body, (args || {}).parser);\n            this._runned = false;\n            this.closeCurrentOnBack = null;\n            this.tempPageData = undefined;\n        }\n        parseUrl(url) {\n            if (!url)\n                throw Errors_1.Errors.argumentNull('url');\n            let routeData = parseUrl(url);\n            return routeData;\n        }\n        createUrl(pageName, values) {\n            return createUrl(pageName, values);\n        }\n        run() {\n            if (this._runned)\n                return;\n            let showPage = () => {\n                let url = location.href;\n                let sharpIndex = url.indexOf('#');\n                let routeString = url.substr(sharpIndex + 1);\n                if (routeString.startsWith('!')) {\n                    return;\n                }\n                if (sharpIndex < 0) {\n                    url = '#' + DefaultPageName;\n                }\n                this.showPageByUrl(url);\n            };\n            showPage();\n            window.addEventListener('hashchange', () => {\n                showPage();\n            });\n            this._runned = true;\n        }\n        showPageByUrl(url) {\n            if (!url)\n                throw Errors_1.Errors.argumentNull('url');\n            let tempPageData = this.fetchTemplatePageData();\n            let result = null;\n            if (this.closeCurrentOnBack == true) {\n                this.closeCurrentOnBack = null;\n                if (tempPageData == null)\n                    this.closeCurrentPage();\n                else\n                    this.closeCurrentPage(tempPageData);\n                result = this.currentPage;\n            }\n            else if (this.closeCurrentOnBack == false) {\n                this.closeCurrentOnBack = null;\n                var page = this.pageStack.pop();\n                if (page == null)\n                    throw new Error('page is null');\n                page.hide(this.currentPage);\n                result = this.currentPage;\n            }\n            if (result == null || result.url != url) {\n                result = this.showPage(url);\n            }\n            return result;\n        }\n        fetchTemplatePageData() {\n            if (this.tempPageData == null) {\n                return null;\n            }\n            let data = this.tempPageData;\n            this.tempPageData = undefined;\n            return data;\n        }\n        setLocationHash(url) {\n            history.pushState(EmtpyStateData, \"\", url);\n        }\n        redirect(pageNameOrUrl, args) {\n            if (!pageNameOrUrl)\n                throw Errors_1.Errors.argumentNull('pageNameOrUrl');\n            let page = this.showPageByNameOrUrl(pageNameOrUrl, args);\n            let url = this.createUrl(page.name, page.data);\n            this.setLocationHash(url);\n            return page;\n        }\n        forward(pageNameOrUrl, args, setUrl) {\n            if (!pageNameOrUrl)\n                throw Errors_1.Errors.argumentNull('pageNameOrUrl');\n            if (setUrl == null)\n                setUrl = true;\n            let page = this.showPageByNameOrUrl(pageNameOrUrl, args, true);\n            if (setUrl) {\n                let url = this.createUrl(page.name, page.data);\n                this.setLocationHash(url);\n            }\n            else {\n                history.pushState(pageNameOrUrl, \"\", \"\");\n            }\n            return page;\n        }\n        showPageByNameOrUrl(pageNameOrUrl, args, rerender) {\n            let pageName;\n            if (pageNameOrUrl.indexOf('?') < 0) {\n                pageName = pageNameOrUrl;\n            }\n            else {\n                let obj = this.parseUrl(pageNameOrUrl);\n                pageName = obj.pageName;\n                args = Object.assign(obj.values, args || {});\n            }\n            return this.showPage(pageName, args, rerender);\n        }\n        reload(pageName, args) {\n            let result = this.showPage(pageName, args, true);\n            return result;\n        }\n        back(closeCurrentPage, data) {\n            const closeCurrentPageDefault = true;\n            if (typeof closeCurrentPage == 'object') {\n                data = closeCurrentPage;\n                closeCurrentPage = null;\n            }\n            this.closeCurrentOnBack = closeCurrentPage == null ? closeCurrentPageDefault : closeCurrentPage;\n            this.tempPageData = data;\n            history.back();\n        }\n        createService(type) {\n            type = type || maishu_chitu_service_1.Service;\n            let service = new type();\n            service.error.add((sender, error) => {\n                this.error.fire(this, error, null);\n            });\n            return service;\n        }\n    }\n    exports.Application = Application;\n});\n"],"file":"Application.js"}